<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de Reboque Google Maps</title>
    <style>
        /* Reset b√°sico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .container {
            background: white;
            max-width: 600px;
            width: 100%;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #444;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 5px;
        }

        /* Formul√°rio */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            user-select: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            outline-offset: 0;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
        }

        /* Bot√£o Padr√£o */
        button {
            cursor: pointer;
            background: #1a73e8;
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            transition: background-color 0.3s ease;
            user-select: none;
            margin-top: 5px;
        }

        button:hover,
        button:focus {
            background: #155ab6;
            outline: none;
        }
        
        /* Estiliza√ß√£o do Toggle de Escolha (CEP vs GEO) */
        .input-toggle {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .input-toggle > label {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #1a73e8;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            flex-grow: 1;
            text-align: center;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            background-color: white;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .radio-group input[type="radio"]:checked + label {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* Fim Estiliza√ß√£o Toggle */

        #resultado {
            font-weight: 700;
            white-space: pre-line;
            font-size: 1.1rem;
            padding: 15px 20px;
            background: #e1f0ff;
            border-radius: 8px;
            border: 1px solid #7ab8ff;
            min-height: 60px;
            color: #0d47a1;
        }
        
        #mensagem-erro {
            color: red; 
            margin-bottom: 10px; 
            padding: 15px; 
            border: 2px solid #f8d7da; 
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            font-weight: 600;
        }

        .whatsapp-button {
            background-color: #25D366; 
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            user-select: none;
        }

        .whatsapp-button:hover,
        .whatsapp-button:focus {
            background-color: #128C7E;
            outline: none;
        }

        #detalhes-moto {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .logo-placeholder {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 20px;
        }

        /* Estilo para a caixa de problemas */
        .troubleshooting {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #0c7b93;
            background-color: #e6f6f9;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .troubleshooting h3 {
            color: #0c7b93;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .troubleshooting ol {
            padding-left: 20px;
            margin-top: 5px;
        }
        .troubleshooting li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .troubleshooting strong {
            color: #0d47a1;
        }
        
        .loading-status {
            font-size: 0.9rem;
            font-weight: 500;
            color: #f90;
            margin-bottom: 15px;
        }

        /* Responsividade */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            .radio-group label {
                flex-basis: 100%;
            }

            input[type="text"],
            input[type="number"],
            select,
            button {
                font-size: 1rem;
                padding: 10px 12px;
            }
        }
    </style>
    <script>
        // =================================================================
        // ATEN√á√ÉO: CHAVE DE API DO GOOGLE MAPS
        // Insira sua chave de API do Google Maps.
        // =================================================================
        const API_KEY_GOOGLE = "AIzaSyBwd9QQquprtp9WM-M3KlzXe6rOKAy41Ns"; // <<-- INSIRA SUA CHAVE GOOGLE AQUI -->>
        
        // Coordenadas da Base (R. Dom Jo√£o VI, 6 - Santa Cruz, RJ)
        const BASE_ADDRESS = { lat: -22.923831, lng: -43.682701 };
        const WHATSAPP_NUMBER = "5521999999999"; 
        
        // Vari√°veis globais para os servi√ßos do Google Maps
        let geocoder;
        let directionsService;
        let isGoogleMapsReady = false;

        // Fun√ß√£o de callback chamada quando o script do Google Maps √© carregado
        function initMap() {
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            isGoogleMapsReady = true;
            document.getElementById("loading-status").textContent = "Status: üü¢ Servi√ßos do Google Maps prontos.";
            console.log("Servi√ßos do Google Maps inicializados.");
        }

        // --- FUN√á√ïES DE UTILIDADE ---
        
        function mostrarMensagemErro(msg) {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "block";
            div.innerHTML = `<strong>${msg}</strong>`;
        }

        function limparMensagemErro() {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "none";
            div.textContent = "";
        }
        
        function updateWhatsappButton(origem, destino, valor) {
            const btn = document.getElementById("whatsapp-solicitar-btn");
            const msg = encodeURIComponent(
                `Ol√°! Gostaria de solicitar um reboque.\n\n` +
                `üìç Origem: ${origem}\n` +
                `üèÅ Destino: ${destino}\n\n` +
                `üíµ Valor estimado: R$ ${valor.toFixed(2)}\n\n` +
                `Por favor, confirme a disponibilidade.`
            );
            btn.removeAttribute('disabled');
            btn.onclick = () => {
                window.open(`https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${msg}`, '_blank');
            };
        }
        
        // --- FUN√á√ïES DE BUSCA/GEOCODING (Google Maps) ---
        
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK') {
                        // Retorna o objeto LatLng e o endere√ßo formatado
                        resolve({ 
                            location: results[0].geometry.location,
                            formatted_address: results[0].formatted_address
                        });
                    } else if (status === 'ZERO_RESULTS') {
                        reject(new Error(`Endere√ßo n√£o encontrado: "${address}"`));
                    } else {
                        reject(new Error(`Geocoding falhou com status: ${status}. (Verifique sua API Key e permiss√µes)`));
                    }
                });
            });
        }
        
        function reverseGeocode(latlng) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'location': latlng }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].formatted_address);
                    } else if (status === 'ZERO_RESULTS') {
                        resolve(`Localiza√ß√£o desconhecida: (${latlng.lat()}, ${latlng.lng()})`);
                    } else {
                        reject(new Error(`Geocoding Reverso falhou com status: ${status}`));
                    }
                });
            });
        }

        async function buscarEnderecoPorCEP(cep, numero) {
            limparMensagemErro(); 

            // 1. Busca no ViaCEP (r√°pido para obter o texto do endere√ßo)
            const responseCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            if (!responseCep.ok) throw new Error(`Falha ao buscar CEP (Status HTTP: ${responseCep.status}).`);
            
            const dataCep = await responseCep.json();
            if (dataCep.erro) throw new Error("CEP n√£o encontrado.");

            const enderecoCompleto = `${dataCep.logradouro}, ${numero} - ${dataCep.bairro}, ${dataCep.localidade} - ${dataCep.uf}`;
            
            // 2. Tentar geocodificar no Google Maps para validar
            const fullQuery = `${enderecoCompleto}, CEP ${cep}`;
            try {
                await geocodeAddress(fullQuery); 
            } catch (e) {
                // Se falhar o geocoding, ainda retornamos o endere√ßo, mas avisamos
                console.warn(`Aviso: Endere√ßo do CEP (${fullQuery}) n√£o foi totalmente reconhecido pelo Google Maps Geocoder.`);
            }
            
            return enderecoCompleto;
        }
        
        // --- FUN√á√ÉO PRINCIPAL DE ROTA (Google Maps) ---
        
        function getDistance(origin, destination) {
             return new Promise((resolve, reject) => {
                const request = {
                    origin: origin,       // LatLng ou String
                    destination: destination, // LatLng ou String
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC 
                };
                
                directionsService.route(request, (response, status) => {
                    if (status === 'OK') {
                        const route = response.routes[0];
                        // O Directions API retorna a dist√¢ncia em metros
                        const distanceMeters = route.legs[0].distance.value; 
                        resolve(distanceMeters / 1000); // Retorna em KM
                    } else if (status === 'ZERO_RESULTS' || status === 'NOT_FOUND') {
                        // Se a rota n√£o for encontrada, tentamos uma pequena varia√ß√£o
                        reject(new Error(`Rota n√£o encontrada (Status: ${status}).`));
                    } else {
                        reject(new Error(`Directions API falhou: ${status}`));
                    }
                });
            });
        }

        // --- FUN√á√ÉO DE C√ÅLCULO GERAL ---

        async function calcular() {
            limparMensagemErro(); 
            
            if (!isGoogleMapsReady) {
                mostrarMensagemErro("‚ùå O Google Maps ainda n√£o carregou ou falhou ao carregar o script. Verifique o console ou sua conex√£o.");
                return;
            }

            document.getElementById("resultado").innerText = "Calculando...";
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            let tipoVeiculo;
            let cilindrada = 0; 
            let coordOrigem, coordDestino;
            let origemAddress, destinoAddress;

            try {
                // 1. Obter e Validar Inputs
                tipoVeiculo = document.getElementById("tipo").value;
                if (!tipoVeiculo) throw new Error("Selecione o tipo de ve√≠culo.");

                origemAddress = document.getElementById("origem").value; 
                destinoAddress = document.getElementById("destino").value; 

                if (!origemAddress || origemAddress.includes("Endere√ßo gerado ap√≥s")) throw new Error("Defina o endere√ßo de Origem primeiro.");
                if (!destinoAddress || destinoAddress.includes("Endere√ßo gerado automaticamente")) throw new Error("Defina o endere√ßo de Destino primeiro.");

                if (tipoVeiculo === "15") {
                    cilindrada = parseInt(document.getElementById("cilindrada-moto").value);
                    if (isNaN(cilindrada)) throw new Error("Informe a cilindrada da moto.");
                }
                
                // 2. Determinar Coordenadas de Origem (Prioriza Geolocaliza√ß√£o salva)
                const savedLon = parseFloat(document.getElementById("coord-origem-lon").value);
                const savedLat = parseFloat(document.getElementById("coord-origem-lat").value);

                if (!isNaN(savedLon) && !isNaN(savedLat)) {
                    // ORIGEM: Geolocaliza√ß√£o
                    coordOrigem = new google.maps.LatLng(savedLat, savedLon);
                } else {
                    // ORIGEM: Geocodifica√ß√£o de Endere√ßo/CEP
                    const cepOrigem = document.getElementById("cep-origem").value.replace(/\D/g, "");
                    const numeroOrigem = document.getElementById("numero-origem").value;
                    const geocodeQueryOrigem = `${origemAddress}, ${numeroOrigem}, CEP ${cepOrigem}`;
                    
                    const result = await geocodeAddress(geocodeQueryOrigem);
                    coordOrigem = result.location;
                    origemAddress = result.formatted_address; // Usa o endere√ßo formatado pelo Google
                }

                // 3. Geocodificar Destino
                const cepDestino = document.getElementById("cep-destino").value.replace(/\D/g, "");
                const numeroDestino = document.getElementById("numero-destino").value;
                const geocodeQueryDestino = `${destinoAddress}, ${numeroDestino}, CEP ${cepDestino}`;
                
                const resultDestino = await geocodeAddress(geocodeQueryDestino);
                coordDestino = resultDestino.location;
                destinoAddress = resultDestino.formatted_address; // Usa o endere√ßo formatado pelo Google
                
                // 4. Determinar Taxa Fixa
                let taxa = 0;
                if (tipoVeiculo === "50") taxa = 50;
                else if (tipoVeiculo === "15") {
                    if (cilindrada <= 160) taxa = 15;
                    else if (cilindrada <= 250) taxa = 25;
                    else if (cilindrada <= 499) taxa = 35;
                    else if (cilindrada <= 999) taxa = 50;
                    else taxa = 100;
                }

                // 5. Calcular Rotas (DirectionsService)
                const coordBase = new google.maps.LatLng(BASE_ADDRESS.lat, BASE_ADDRESS.lng);
                
                const [dist1, dist2, dist3] = await Promise.all([
                    getDistance(coordBase, coordOrigem),    // Base -> Origem
                    getDistance(coordOrigem, coordDestino), // Origem -> Destino
                    getDistance(coordDestino, coordBase)    // Destino -> Base
                ]); 

                // 6. Apresentar Resultado
                const distanciaTotalKm = dist1 + dist2 + dist3;
                const valorKm = distanciaTotalKm * 1.7; // R$ 1,70 por km
                const valorTotal = valorKm + taxa;
                
                const detalhesMoto = tipoVeiculo === "15" ? 
                    ` (Cilindrada: ${document.getElementById("cilindrada-moto").value}cc)` : '';
                
                document.getElementById("resultado").innerText =
                    `API Utilizada: Google Maps Directions Service\n\n` +
                    `Detalhes da Rota:\n` +
                    `Base ‚Üí Origem: ${dist1.toFixed(2)} km\n` +
                    `Origem ‚Üí Destino: ${dist2.toFixed(2)} km\n` +
                    `Destino ‚Üí Base: ${dist3.toFixed(2)} km\n\n` +
                    `Dist√¢ncia Total (ida e volta): ${distanciaTotalKm.toFixed(2)} km\n` +
                    `Custo por KM (R$ 1,70/km): R$ ${valorKm.toFixed(2)}\n` +
                    `Taxa Fixa (Ve√≠culo: ${tipoVeiculo === '50' ? 'Carro' : 'Moto'}${detalhesMoto}): R$ ${taxa.toFixed(2)}\n` +
                    `\nüí∞ VALOR TOTAL ESTIMADO: R$ ${valorTotal.toFixed(2)}`;
                
                updateWhatsappButton(origemAddress, destinoAddress, valorTotal);
                
            } catch (error) {
                console.error("Erro no c√°lculo:", error);
                
                let userMessage = error.message;

                if (userMessage.includes("NetworkError")) {
                    userMessage = `Falha na requisi√ß√£o de rede (NetworkError). Isso √© um bloqueio externo.`;
                } else if (userMessage.includes("Status: REQUEST_DENIED") || userMessage.includes("InvalidKey")) {
                    userMessage = `CHAVE INV√ÅLIDA (REQUEST_DENIED). Verifique se a chave est√° correta e APIs ativadas.`;
                } else if (userMessage.includes("Status: OVER_QUERY_LIMIT")) {
                    userMessage = `Limite de requisi√ß√µes excedido. Verifique o faturamento no Google Cloud Console.`;
                }

                mostrarMensagemErro(`‚ùå Erro: ${userMessage}`); 
                document.getElementById("resultado").innerText = "‚ùå Erro no c√°lculo. Consulte a mensagem acima e o checklist de diagn√≥stico.";
                document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            }
        }

        // === FLUXO DE BUSCA DE ENDERE√áO COM TOGGLE ===
        
        function toggleOriginInput(choice) {
            limparMensagemErro();
            const cepBlock = document.getElementById("cep-input-block");
            const geoBlock = document.getElementById("geo-input-block");
            const origemField = document.getElementById("origem");

            if (choice === 'cep') {
                cepBlock.style.display = 'block';
                geoBlock.style.display = 'none';
                
                // Limpar dados de Geolocaliza√ß√£o (para evitar conflito no c√°lculo)
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
                origemField.value = "";
                origemField.placeholder = "Endere√ßo gerado ap√≥s busca por CEP";
                
            } else if (choice === 'geo') {
                cepBlock.style.display = 'none';
                geoBlock.style.display = 'block';
                
                // Limpar dados de CEP
                document.getElementById("cep-origem").value = "";
                document.getElementById("numero-origem").value = "";
                origemField.value = "";
                origemField.placeholder = "Endere√ßo gerado ap√≥s obter Localiza√ß√£o Atual";
            }
        }
        
        async function buscarOrigemCEP() {
            if (!isGoogleMapsReady) {
                 mostrarMensagemErro("Aguardando Google Maps carregar...");
                 return;
            }
            limparMensagemErro();
            const cep = document.getElementById("cep-origem").value.replace(/\D/g, "");
            const numero = document.getElementById("numero-origem").value;
            if (!cep || !numero) {
                 mostrarMensagemErro("Preencha CEP e N√∫mero para buscar o endere√ßo.");
                 return;
            }
            try {
                // Assegura que as coordenadas est√£o limpas para for√ßar o Geocoding
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
                
                const end = await buscarEnderecoPorCEP(cep, numero);
                document.getElementById("origem").value = end;
            } catch (e) {
                mostrarMensagemErro(`‚ùå Erro na busca de Origem: ${e.message}`);
                document.getElementById("origem").value = "";
            }
        }

        async function usarLocalizacaoAtual() {
            if (!isGoogleMapsReady) {
                 mostrarMensagemErro("Aguardando Google Maps carregar...");
                 return;
            }
            limparMensagemErro();
            document.getElementById("origem").value = "Buscando localiza√ß√£o...";
            document.getElementById("btn-usar-localizacao").disabled = true;

            if (!navigator.geolocation) {
                mostrarMensagemErro("Seu navegador n√£o suporta geolocaliza√ß√£o.");
                document.getElementById("origem").value = "";
                document.getElementById("btn-usar-localizacao").disabled = false;
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                const latlng = { lat: lat, lng: lon };
                
                // 1. Tentar reverter as coordenadas para endere√ßo de texto (Google Maps)
                const enderecoTexto = await reverseGeocode(latlng);
                
                // 2. Salvar as coordenadas reais nos campos hidden para usar no c√°lculo
                document.getElementById("coord-origem-lon").value = lon;
                document.getElementById("coord-origem-lat").value = lat;

                // 3. Limpar CEP/N√∫mero e popular campo de endere√ßo
                document.getElementById("origem").value = `(LOCALIZA√á√ÉO ATUAL) ${enderecoTexto}`;
                
            } catch (error) {
                let msg = "Erro ao obter localiza√ß√£o. Verifique as permiss√µes do navegador.";
                if (error.code === 1) {
                    msg = "Permiss√£o de geolocaliza√ß√£o negada pelo usu√°rio.";
                } else if (error.code === 3) {
                    msg = "Tempo limite excedido para obter localiza√ß√£o.";
                } else {
                    msg = `Falha na geolocaliza√ß√£o ou no reconhecimento do endere√ßo: ${error.message}`;
                }
                mostrarMensagemErro(`‚ùå ${msg}`);
                document.getElementById("origem").value = "";
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
            } finally {
                document.getElementById("btn-usar-localizacao").disabled = false;
            }
        }

        async function buscarDestinoCEP() {
            if (!isGoogleMapsReady) {
                 mostrarMensagemErro("Aguardando Google Maps carregar...");
                 return;
            }
            limparMensagemErro();
            const cep = document.getElementById("cep-destino").value.replace(/\D/g, "");
            const numero = document.getElementById("numero-destino").value;
            if (!cep || !numero) {
                 mostrarMensagemErro("Preencha CEP e N√∫mero do destino para buscar o endere√ßo.");
                 return;
            }
            try {
                const end = await buscarEnderecoPorCEP(cep, numero);
                document.getElementById("destino").value = end;
            } catch (e) {
                mostrarMensagemErro(`‚ùå Erro na busca de Destino: ${e.message}`);
                document.getElementById("destino").value = "";
            }
        }

        // --- SETUP INICIAL ---
        window.onload = function() {
            
            document.getElementById("btn-calcular").addEventListener("click", calcular);
            
            // Listeners para os bot√µes de busca
            document.getElementById("btn-buscar-origem-cep").addEventListener("click", buscarOrigemCEP);
            document.getElementById("btn-usar-localizacao").addEventListener("click", usarLocalizacaoAtual);
            document.getElementById("btn-buscar-destino").addEventListener("click", buscarDestinoCEP);
            
            // Listener para o Radio Group (Altern√¢ncia)
            document.querySelectorAll('input[name="origin-choice"]').forEach(radio => {
                radio.addEventListener('change', (e) => toggleOriginInput(e.target.value));
            });
            
            // Inicializa o estado (mostra CEP por padr√£o)
            toggleOriginInput('cep');

            document.getElementById("tipo").addEventListener("change", e => {
                const showMoto = e.target.value === "15";
                document.getElementById("detalhes-moto").style.display = showMoto ? "block" : "none";
                
                if (!showMoto) {
                    document.getElementById("marca-moto").value = "";
                    document.getElementById("modelo-moto").value = "";
                    document.getElementById("cilindrada-moto").value = "";
                }
            });
            
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            // Display da chave de API
            const apiKeyDisplay = document.getElementById("api-key-display-value");
            if (API_KEY_GOOGLE === "YOUR_GOOGLE_API_KEY") {
                 mostrarMensagemErro("‚ö†Ô∏è ATEN√á√ÉO: A Chave de API do Google Maps est√° como placeholder. Por favor, edite o arquivo e insira sua chave no campo 'API_KEY_GOOGLE' no topo do bloco <script>.");
                 apiKeyDisplay.value = "Chave n√£o configurada";
            } else {
                 apiKeyDisplay.value = API_KEY_GOOGLE.substring(0, 4) + "..." + API_KEY_GOOGLE.substring(API_KEY_GOOGLE.length - 4);
            }
            
            // Inje√ß√£o do script do Google Maps
            if (API_KEY_GOOGLE !== "YOUR_GOOGLE_API_KEY") {
                 const script = document.createElement('script');
                 script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY_GOOGLE}&libraries=geometry&callback=initMap`;
                 script.onerror = () => {
                     document.getElementById("loading-status").textContent = "Status: üî¥ FALHA DE REDE/CORS. O script do Google Maps n√£o p√¥de ser carregado. Consulte o Checklist.";
                     mostrarMensagemErro("‚ùå O script do Google Maps falhou ao carregar (Network Error/CORS). O c√°lculo n√£o funcionar√°.");
                 };
                 document.head.appendChild(script);
            } else {
                 document.getElementById("loading-status").textContent = "Status: üî¥ API Key n√£o configurada. Insira sua chave no c√≥digo.";
            }
        };
    </script>
</head>
<body>
    <main class="container">
        <h1 class="logo-placeholder">üöö Gbservice Reboque</h1>
        
        <div class="form-group">
            <label for="api-key-display-value">API Key Google - 4 d√≠gitos iniciais/finais:</label>
            <input type="text" id="api-key-display-value" value="" style="background-color: #e1f0ff; color: #0d47a1; font-weight: bold;"/>
        </div>
        <p id="loading-status" class="loading-status">Status: üü° Carregando servi√ßos do Google Maps...</p>


        <div id="mensagem-erro" class="mensagem-erro" style="display: none;"></div>
        
        <!-- CAMPOS HIDDEN PARA SALVAR COORDENADAS DA GEOLOCALIZA√á√ÉO -->
        <input type="hidden" id="coord-origem-lon" value="" />
        <input type="hidden" id="coord-origem-lat" value="" />

        <section class="section endereco-section">
            <h2>Local do Ve√≠culo (Origem)</h2>
            
            <div class="input-toggle">
                <label>Como deseja informar a Origem?</label>
                <div class="radio-group">
                    <input type="radio" id="choice-cep" name="origin-choice" value="cep" checked>
                    <label for="choice-cep">CEP / Endere√ßo</label>
                    
                    <input type="radio" id="choice-geo" name="origin-choice" value="geo">
                    <label for="choice-geo">Localiza√ß√£o Atual</label>
                </div>
            </div>

            <!-- BLOCO DE INPUT POR CEP/ENDERE√áO -->
            <div id="cep-input-block" class="input-block">
                <div class="form-group">
                    <label for="cep-origem">CEP:</label>
                    <input type="text" id="cep-origem" placeholder="Ex: 23560000" maxlength="8" autocomplete="postal-code" />
                </div>
                <div class="form-group">
                    <label for="numero-origem">N√∫mero:</label>
                    <input type="number" id="numero-origem" placeholder="N√∫mero do endere√ßo" autocomplete="address-level1" />
                </div>
                <button id="btn-buscar-origem-cep" type="button">Buscar Endere√ßo</button>
            </div>

            <!-- BLOCO DE INPUT POR GEOLOCALIZA√á√ÉO -->
            <div id="geo-input-block" class="input-block" style="display: none;">
                <button id="btn-usar-localizacao" type="button" style="background-color: #38a169; margin-bottom: 10px;">
                    Usar Minha Localiza√ß√£o Atual
                </button>
            </div>
            
            <!-- CAMPO DE ENDERE√áO RESULTANTE (comum aos dois m√©todos) -->
            <div class="form-group">
                <label for="origem">Endere√ßo completo (Gerado automaticamente):</label>
                <input disabled type="text" id="origem" placeholder="Endere√ßo gerado ap√≥s busca ou localiza√ß√£o" autocomplete="street-address" />
            </div>
        </section>

        <section class="section destino-section">
            <h2>Destino do Reboque</h2>
            <div class="form-group">
                <label for="cep-destino">CEP:</label>
                <input type="text" id="cep-destino" placeholder="Digite o CEP da rua de destino" maxlength="8" autocomplete="postal-code" />
            </div>
            <div class="form-group">
                <label for="numero-destino">N√∫mero:</label>
                <input type="number" id="numero-destino" placeholder="N√∫mero" autocomplete="address-level1" />
            </div>
            
            <button id="btn-buscar-destino" type="button" class="button-buscar">Buscar Endere√ßo de Destino</button>
            
            <div class="form-group">
                <label for="destino">Endere√ßo de destino completo:</label>
                <input disabled type="text" id="destino" placeholder="Endere√ßo gerado automaticamente" autocomplete="address-line1" />
            </div>
            <div class="form-group">
                <label for="tipo">Tipo de Ve√≠culo:</label>
                <select id="tipo" aria-label="Tipo de ve√≠culo">
                    <option value="" disabled selected>Selecione</option>
                    <option value="50">Carro</option>
                    <option value="15">Moto</option>
                </select>
            </div>
            <div id="detalhes-moto" style="display: none;">
                <div class="form-group">
                    <label for="marca-moto">Marca:</label>
                    <input type="text" id="marca-moto" placeholder="Ex.: Honda" />
                </div>
                <div class="form-group">
                    <label for="modelo-moto">Modelo:</label>
                    <input type="text" id="modelo-moto" placeholder="Ex.: CG Titan" />
                </div>
                <div class="form-group">
                    <label for="cilindrada-moto">Cilindrada:</label>
                    <input type="number" id="cilindrada-moto" placeholder="Ex.: 160" />
                </div>
            </div>
        </section>

        <section class="section acao-section">
            <button id="btn-calcular" type="button">Calcular valor</button>
        </section>

        <section class="section resultado-section" aria-live="polite" aria-atomic="true">
            <div id="resultado">Preencha todos os campos e clique em CALCULAR.</div>
            <div class="troubleshooting">
                <h3>üõ†Ô∏è Checklist de Diagn√≥stico (Network Error)</h3>
                <p>Se o erro de rede persistir (o c√°lculo n√£o iniciar ou a mensagem de status permanecer üî¥), <strong>O PROBLEMA √â EXTERNO</strong>:</p>
                <ol>
                    <li><strong>APIs Ativadas:</strong> Confirme que **Geocoding API** e **Directions API** est√£o ativadas no Google Cloud Console.</li>
                    <li><strong>Faturamento:</strong> Confirme que o Cart√£o de Cr√©dito est√° v√°lido e o faturamento est√° ativo (um `OVER_QUERY_LIMIT` √© gerado se estiver inativo).</li>
                    <li><strong>Restri√ß√µes de Referer (CR√çTICO):</strong> Na configura√ß√£o da sua chave, em "Restri√ß√µes de aplicativos", mude de "Referers HTTP (sites)" para **"Nenhum"** ou adicione o Referer **`*`** para testes (em ambientes de iframe restritos, isso √© vital).</li>
                    <li><strong>Rede Local:</strong> Tente usar uma VPN ou mudar de rede. Se a falha for na hora de carregar o script do Google Maps (`Status: üî¥ FALHA DE REDE`), √© seu firewall ou um ad-blocker bloqueando o dom√≠nio `maps.googleapis.com`.</li>
                </ol>
            </div>
        </section>

        <section class="section whatsapp-section">
            <button id="whatsapp-solicitar-btn" class="whatsapp-button" disabled>Solicitar reboque via WhatsApp</button>
        </section>
        <footer class="footer">
            <p>Desenvolvido por <strong>Natanael Costa</strong></p>
        </footer>
    </main>
</body>
</html>
