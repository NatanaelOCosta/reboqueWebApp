<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de Reboque Google Maps</title>
    <style>
        /* Reset básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .container {
            background: white;
            max-width: 600px;
            width: 100%;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #444;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 5px;
        }

        /* Formulário */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            user-select: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            outline-offset: 0;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
        }

        /* Botão Padrão */
        button {
            cursor: pointer;
            background: #1a73e8;
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            transition: background-color 0.3s ease;
            user-select: none;
            margin-top: 5px;
        }

        button:hover,
        button:focus {
            background: #155ab6;
            outline: none;
        }
        
        /* Estilização do Toggle de Escolha (CEP vs GEO) */
        .input-toggle {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .input-toggle > label {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #1a73e8;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            flex-grow: 1;
            text-align: center;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            background-color: white;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .radio-group input[type="radio"]:checked + label {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* Fim Estilização Toggle */

        /* Estilos do Mapa */
        #map-canvas {
            height: 300px; /* Altura fixa para visualização */
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-top: 15px;
            background-color: #e9e9e9;
        }
        
        .map-controls {
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .map-status {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1a73e8;
        }
        
        #resultado {
            font-weight: 700;
            white-space: pre-line;
            font-size: 1.1rem;
            padding: 15px 20px;
            background: #e1f0ff;
            border-radius: 8px;
            border: 1px solid #7ab8ff;
            min-height: 60px;
            color: #0d47a1;
        }
        
        #mensagem-erro {
            color: red; 
            margin-bottom: 10px; 
            padding: 15px; 
            border: 2px solid #f8d7da; 
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            font-weight: 600;
        }

        .whatsapp-button {
            background-color: #25D366; 
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            user-select: none;
        }

        .whatsapp-button:hover,
        .whatsapp-button:focus {
            background-color: #128C7E;
            outline: none;
        }

        #detalhes-moto {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .logo-placeholder {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 20px;
        }
        
        /* Responsividade */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            .radio-group label {
                flex-basis: 100%;
            }

            input[type="text"],
            input[type="number"],
            select,
            button {
                font-size: 1rem;
                padding: 10px 12px;
            }
        }
    </style>
    <script>
        // =================================================================
        // ATENÇÃO: CHAVE DE API DO GOOGLE MAPS
        // =================================================================
        const API_KEY_GOOGLE = "AIzaSyBwd9QQquprtp9WM-M3KlzXe6rOKAy41Ns";
        
        // Coordenadas da Base (R. Dom João VI, 6 - Santa Cruz, RJ)
        const BASE_ADDRESS = { lat: -22.923831, lng: -43.682701 };
        const WHATSAPP_NUMBER = "552141014470"; 
        
        // Variáveis globais para os serviços do Google Maps
        let geocoder;
        let directionsService;
        let map;
        let originMarker, destinationMarker;
        let isGoogleMapsReady = false;
        let currentMapMode = null; // 'ORIGIN' ou 'DESTINATION'
        const RIO_CENTER = { lat: -22.9068, lng: -43.1729 }; // Centro do Rio de Janeiro

        // Função de callback chamada quando o script do Google Maps é carregado
        function initMap() {
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            isGoogleMapsReady = true;
            console.log("Serviços do Google Maps inicializados.");
            
            // Inicialização do mapa (oculto inicialmente)
            const mapCanvas = document.getElementById('map-canvas');
            if(mapCanvas) {
                map = new google.maps.Map(mapCanvas, {
                    center: RIO_CENTER,
                    zoom: 10,
                    fullscreenControl: false,
                    streetViewControl: false,
                    // Ponto 2: 'greedy' prioriza a interação com o mapa sobre a rolagem da página (melhorando mobile)
                    gestureHandling: 'greedy' 
                });

                // Marcador de Origem (Vermelho)
                originMarker = new google.maps.Marker({
                    map: map,
                    position: BASE_ADDRESS, 
                    icon: { 
                        url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" 
                    }
                });
                
                // Marcador de Destino (Azul)
                destinationMarker = new google.maps.Marker({
                    map: map,
                    position: RIO_CENTER, 
                    icon: { 
                        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" 
                    }
                });

                originMarker.setVisible(false);
                destinationMarker.setVisible(false);

                // Listener de clique no mapa
                map.addListener('click', handleMapClick);
            }
        }

        // --- FUNÇÕES DE UTILIDADE ---
        
        function mostrarMensagemErro(msg) {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "block";
            div.innerHTML = `<strong>${msg}</strong>`;
        }

        function limparMensagemErro() {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "none";
            div.textContent = "";
        }
        
        function updateWhatsappButton(origem, destino, valor) {
            const btn = document.getElementById("whatsapp-solicitar-btn");
            const msg = encodeURIComponent(
                `Olá! Gostaria de solicitar um reboque.\n\n` +
                `📍 Origem: ${origem}\n` +
                `🏁 Destino: ${destino}\n\n` +
                `💵 Valor estimado: R$ ${valor.toFixed(2)}\n\n` +
                `Por favor, confirme a disponibilidade.`
            );
            btn.removeAttribute('disabled');
            btn.onclick = () => {
                window.open(`https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${msg}`, '_blank');
            };
        }
        
        // --- FUNÇÕES DE BUSCA/GEOCODING (Google Maps) ---
        
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK') {
                        // Retorna o objeto LatLng e o endereço formatado
                        resolve({ 
                            location: results[0].geometry.location,
                            formatted_address: results[0].formatted_address
                        });
                    } else if (status === 'ZERO_RESULTS') {
                        reject(new Error(`Endereço não encontrado: "${address}"`));
                    } else {
                        reject(new Error(`Falha na busca do endereço com status: ${status}.`));
                    }
                });
            });
        }
        
        function reverseGeocode(latlng) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'location': latlng }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].formatted_address);
                    } else if (status === 'ZERO_RESULTS') {
                        resolve(`Localização desconhecida: (${latlng.lat()}, ${latlng.lng()})`);
                    } else {
                        reject(new Error(`Falha no Geocoding Reverso com status: ${status}`));
                    }
                });
            });
        }

        async function buscarEnderecoPorCEP(cep, numero) {
            limparMensagemErro(); 

            // 1. Busca no ViaCEP (rápido para obter o texto do endereço)
            const responseCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            if (!responseCep.ok) throw new Error(`Falha ao buscar CEP (Status HTTP: ${responseCep.status}).`);
            
            const dataCep = await responseCep.json();
            if (dataCep.erro) throw new Error("CEP não encontrado.");

            const enderecoCompleto = `${dataCep.logradouro}, ${numero} - ${dataCep.bairro}, ${dataCep.localidade} - ${dataCep.uf}`;
            
            // 2. Tentar geocodificar no Google Maps para validar
            const fullQuery = `${enderecoCompleto}, CEP ${cep}`;
            try {
                // Apenas chama para validar
                await geocodeAddress(fullQuery); 
            } catch (e) {
                console.warn(`Aviso: Endereço do CEP (${fullQuery}) não foi totalmente reconhecido pelo Google Maps Geocoder.`);
            }
            
            return enderecoCompleto;
        }
        
        // --- FUNÇÃO PRINCIPAL DE ROTA (Google Maps) ---
        
        function getDistance(origin, destination) {
             return new Promise((resolve, reject) => {
                const request = {
                    origin: origin,       
                    destination: destination, 
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC 
                };
                
                directionsService.route(request, (response, status) => {
                    if (status === 'OK') {
                        const route = response.routes[0];
                        // O Directions API retorna a distância em metros
                        const distanceMeters = route.legs[0].distance.value; 
                        resolve(distanceMeters / 1000); // Retorna em KM
                    } else if (status === 'ZERO_RESULTS' || status === 'NOT_FOUND') {
                        reject(new Error(`Rota não encontrada (Status: ${status}).`));
                    } else {
                        reject(new Error(`Falha ao calcular rota: ${status}`));
                    }
                });
            });
        }

        // --- FUNÇÃO DE CÁLCULO GERAL ---

        async function calcular() {
            limparMensagemErro(); 
            
            if (!isGoogleMapsReady) {
                mostrarMensagemErro("❌ Os serviços de mapa ainda não estão prontos. Tente recarregar a página.");
                return;
            }

            document.getElementById("resultado").innerText = "Calculando...";
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            let tipoVeiculo;
            let cilindrada = 0; 
            let coordOrigem, coordDestino;
            let origemAddress, destinoAddress;

            try {
                // 1. Obter e Validar Inputs
                tipoVeiculo = document.getElementById("tipo").value;
                if (!tipoVeiculo) throw new Error("Selecione o tipo de veículo.");

                origemAddress = document.getElementById("origem").value; 
                destinoAddress = document.getElementById("destino").value; 

                if (!origemAddress || origemAddress.includes("Selecione a Origem")) throw new Error("Defina o endereço de Origem primeiro.");
                if (!destinoAddress || destinoAddress.includes("Selecione o Destino")) throw new Error("Defina o endereço de Destino primeiro.");

                if (tipoVeiculo === "15") {
                    cilindrada = parseInt(document.getElementById("cilindrada-moto").value);
                    if (isNaN(cilindrada)) throw new Error("Informe a cilindrada da moto.");
                }
                
                // 2. Determinar Coordenadas de Origem (Prioriza Geolocalização ou Mapa)
                const savedLon = parseFloat(document.getElementById("coord-origem-lon").value);
                const savedLat = parseFloat(document.getElementById("coord-origem-lat").value);

                if (!isNaN(savedLon) && !isNaN(savedLat)) {
                    // ORIGEM: Geolocalização ou Mapa (coordenadas salvas)
                    coordOrigem = new google.maps.LatLng(savedLat, savedLon);
                } else {
                    // ORIGEM: Geocodificação de Endereço/CEP
                    const cepOrigem = document.getElementById("cep-origem").value.replace(/\D/g, "");
                    const numeroOrigem = document.getElementById("numero-origem").value;
                    const geocodeQueryOrigem = `${origemAddress}, ${numeroOrigem}, CEP ${cepOrigem}`; 
                    
                    const result = await geocodeAddress(geocodeQueryOrigem);
                    coordOrigem = result.location;
                    origemAddress = result.formatted_address; // Usa o endereço formatado pelo Google
                }

                // 3. Determinar Coordenadas de Destino (Prioriza Mapa)
                const savedDestLon = parseFloat(document.getElementById("coord-destino-lon").value);
                const savedDestLat = parseFloat(document.getElementById("coord-destino-lat").value);
                
                if (!isNaN(savedDestLon) && !isNaN(savedDestLat)) {
                    // DESTINO: Mapa (coordenadas salvas)
                    coordDestino = new google.maps.LatLng(savedDestLat, savedDestLon);
                } else {
                    // DESTINO: Geocodificação de Endereço/CEP
                    const cepDestino = document.getElementById("cep-destino").value.replace(/\D/g, "");
                    const numeroDestino = document.getElementById("numero-destino").value;
                    const geocodeQueryDestino = `${destinoAddress}, ${numeroDestino}, CEP ${cepDestino}`;
                    
                    const resultDestino = await geocodeAddress(geocodeQueryDestino);
                    coordDestino = resultDestino.location;
                    destinoAddress = resultDestino.formatted_address; // Usa o endereço formatado pelo Google
                }
                
                // 4. Determinar Taxa Fixa
                let taxa = 0;
                if (tipoVeiculo === "50") taxa = 50;
                else if (tipoVeiculo === "15") {
                    if (cilindrada <= 160) taxa = 15;
                    else if (cilindrada <= 250) taxa = 25;
                    else if (cilindrada <= 499) taxa = 35;
                    else if (cilindrada <= 999) taxa = 50;
                    else taxa = 100;
                }

                // 5. Calcular Rotas (DirectionsService)
                const coordBase = new google.maps.LatLng(BASE_ADDRESS.lat, BASE_ADDRESS.lng);
                
                const [dist1, dist2, dist3] = await Promise.all([
                    getDistance(coordBase, coordOrigem),    // Base -> Origem
                    getDistance(coordOrigem, coordDestino), // Origem -> Destino
                    getDistance(coordDestino, coordBase)    // Destino -> Base
                ]); 

                // 6. Apresentar Resultado
                const distanciaTotalKm = dist1 + dist2 + dist3;
                const valorKm = distanciaTotalKm * 1.7; // R$ 1,70 por km
                const valorTotal = valorKm + taxa;
                
                const detalhesMoto = tipoVeiculo === "15" ? 
                    ` (Cilindrada: ${document.getElementById("cilindrada-moto").value}cc)` : '';
                
                document.getElementById("resultado").innerText =
                    `Detalhes da Rota:\n` +
                    `Base → Origem: ${dist1.toFixed(2)} km\n` +
                    `Origem → Destino: ${dist2.toFixed(2)} km\n` +
                    `Destino → Base: ${dist3.toFixed(2)} km\n\n` +
                    `Distância Total (ida e volta): ${distanciaTotalKm.toFixed(2)} km\n` +
                    `Custo por KM (R$ 1,70/km): R$ ${valorKm.toFixed(2)}\n` +
                    `Taxa Fixa (Veículo: ${tipoVeiculo === '50' ? 'Carro' : 'Moto'}${detalhesMoto}): R$ ${taxa.toFixed(2)}\n` +
                    `\n💰 VALOR TOTAL ESTIMADO: R$ ${valorTotal.toFixed(2)}`;
                
                updateWhatsappButton(origemAddress, destinoAddress, valorTotal);
                
            } catch (error) {
                console.error("Erro no cálculo:", error);
                
                let userMessage = error.message;

                // Simplificação das mensagens de erro para o usuário final
                if (userMessage.includes("NetworkError")) {
                    userMessage = `Falha de conexão. Verifique sua rede.`;
                } else if (userMessage.includes("REQUEST_DENIED") || userMessage.includes("InvalidKey")) {
                    userMessage = `Falha de autenticação com o mapa. Chave de API inválida ou sem permissão.`;
                } else if (userMessage.includes("OVER_QUERY_LIMIT")) {
                    userMessage = `O limite de cálculos foi atingido. Tente novamente mais tarde.`;
                } else if (userMessage.includes("Rota não encontrada")) {
                    userMessage = `Não foi possível traçar a rota. Verifique a precisão dos endereços.`;
                } else if (userMessage.includes("Endereço não encontrado")) {
                     userMessage = `O endereço fornecido não foi reconhecido. Tente outro formato ou CEP.`;
                }

                mostrarMensagemErro(`❌ Erro: ${userMessage}`); 
                document.getElementById("resultado").innerText = "❌ Erro no cálculo. Verifique a mensagem acima.";
                document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            }
        }

        // === FLUXO DE MAPA INTERATIVO (PONTOS 1 e 2 RESOLVIDOS AQUI) ===
        
        function toggleMapSection(mode) {
            const mapSection = document.getElementById("map-interaction-section");
            const mapStatus = document.getElementById("map-status");
            let targetPlaceholder;
            
            // Encontra o placeholder correto para injetar o mapa
            if (mode === 'ORIGIN') {
                targetPlaceholder = document.getElementById("origin-map-placeholder");
            } else { // 'DESTINATION'
                targetPlaceholder = document.getElementById("destination-map-placeholder");
            }

            if (currentMapMode === mode) {
                // Desativa o modo: move o mapa para fora do fluxo visível e oculta
                currentMapMode = null;
                mapSection.style.display = 'none';
                mapStatus.textContent = '';
                // Oculta os marcadores ao fechar
                originMarker.setVisible(false);
                destinationMarker.setVisible(false);
                
            } else {
                // Se estava ativo em outro modo, desativa o antigo
                if (currentMapMode !== null) {
                    document.getElementById("map-interaction-section").style.display = 'none';
                }
                
                currentMapMode = mode;
                
                // PONTO 1: Move o mapa para o novo placeholder (IMEDIATAMENTE ABAIXO DO BOTÃO)
                targetPlaceholder.appendChild(mapSection); 
                mapSection.style.display = 'block';

                // Reajusta o mapa após movê-lo (necessário para que ele renderize corretamente)
                google.maps.event.trigger(map, 'resize'); 
                
                // Centraliza o mapa
                const center = (mode === 'ORIGIN') ? originMarker.getPosition() || new google.maps.LatLng(BASE_ADDRESS.lat, BASE_ADDRESS.lng) : destinationMarker.getPosition() || RIO_CENTER;
                map.setCenter(center);
                map.setZoom(14); 
                
                // Atualiza o status de instrução
                mapStatus.textContent = `Modo Ativo: CLIQUE no mapa para definir o ponto de ${mode === 'ORIGIN' ? 'ORIGEM' : 'DESTINO'}.`;
                
                // Oculta/Mostra marcadores
                originMarker.setVisible(mode === 'ORIGIN');
                destinationMarker.setVisible(mode === 'DESTINATION');
                
                // Rola para a seção do mapa para garantir que o usuário veja
                mapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        async function handleMapClick(event) {
            if (!currentMapMode) return;
            
            limparMensagemErro();
            const latlng = event.latLng;
            let marker, addressField, coordLatField, coordLonField;
            
            const mapStatus = document.getElementById("map-status");
            mapStatus.textContent = "Buscando endereço (Geocoding Reverso)...";

            try {
                const enderecoTexto = await reverseGeocode(latlng);
                
                if (currentMapMode === 'ORIGIN') {
                    marker = originMarker;
                    addressField = document.getElementById('origem');
                    coordLatField = document.getElementById('coord-origem-lat');
                    coordLonField = document.getElementById('coord-origem-lon');
                    
                    // Se a origem é definida por mapa, limpamos os campos CEP
                    document.getElementById("cep-origem").value = "";
                    document.getElementById("numero-origem").value = "";
                    
                } else { // 'DESTINATION'
                    marker = destinationMarker;
                    addressField = document.getElementById('destino');
                    coordLatField = document.getElementById('coord-destino-lat');
                    coordLonField = document.getElementById('coord-destino-lon');
                    
                    // Se o destino é definido por mapa, limpamos os campos CEP
                    document.getElementById("cep-destino").value = "";
                    document.getElementById("numero-destino").value = "";
                }

                // 1. Atualiza o Marcador
                marker.setPosition(latlng);
                marker.setVisible(true);
                
                // 2. Atualiza o Endereço de Texto (PONTO 3 RESOLVIDO)
                addressField.value = `${enderecoTexto} (Mapa)`;
                addressField.style.fontWeight = 'bold'; // Feedback visual
                
                // 3. Atualiza as Coordenadas Ocultas (Para o cálculo)
                coordLatField.value = latlng.lat();
                coordLonField.value = latlng.lng();
                
                mapStatus.textContent = `${currentMapMode === 'ORIGIN' ? 'Origem' : 'Destino'} definido: ${enderecoTexto}. Clique no botão "Selecionar no Mapa" para fechar.`;

            } catch (e) {
                mostrarMensagemErro(`❌ Erro ao definir localização: ${e.message}`);
            }
        }
        
        // === FLUXO DE BUSCA DE ENDEREÇO COM CEP/GEOLOCALIZAÇÃO ===
        
        function toggleOriginInput(choice) {
            limparMensagemErro();
            const cepBlock = document.getElementById("cep-input-block");
            const geoBlock = document.getElementById("geo-input-block");
            const origemField = document.getElementById("origem");
            
            // Limpa coordenadas salvas do mapa/geo para garantir que o cálculo usará o CEP/Endereço
            document.getElementById("coord-origem-lon").value = "";
            document.getElementById("coord-origem-lat").value = "";
            origemField.style.fontWeight = 'normal';

            if (choice === 'cep') {
                cepBlock.style.display = 'block';
                geoBlock.style.display = 'none';
                origemField.value = "";
                origemField.placeholder = "Endereço gerado após busca por CEP";
                
            } else if (choice === 'geo') {
                cepBlock.style.display = 'none';
                geoBlock.style.display = 'block';
                
                document.getElementById("cep-origem").value = "";
                document.getElementById("numero-origem").value = "";
                origemField.value = "";
                origemField.placeholder = "Endereço gerado após obter Localização Atual";
            }
        }
        
        async function buscarOrigemCEP() {
            if (!isGoogleMapsReady) {
                 mostrarMensagemErro("❌ Os serviços de mapa ainda não estão prontos.");
                 return;
            }
            limparMensagemErro();
            const cep = document.getElementById("cep-origem").value.replace(/\D/g, "");
            const numero = document.getElementById("numero-origem").value;
            if (!cep || !numero) {
                 mostrarMensagemErro("Preencha CEP e Número para buscar o endereço.");
                 return;
            }
            try {
                // Força o uso do Geocoding por endereço (limpando coordenadas)
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
                
                const end = await buscarEnderecoPorCEP(cep, numero);
                document.getElementById("origem").value = end;
                document.getElementById("origem").style.fontWeight = 'bold';
            } catch (e) {
                mostrarMensagemErro(`❌ Erro na busca de Origem: ${e.message}`);
                document.getElementById("origem").value = "";
            }
        }

        async function usarLocalizacaoAtual() {
            if (!isGoogleMapsReady) {
                 mostrarMensagemErro("❌ Os serviços de mapa ainda não estão prontos.");
                 return;
            }
            limparMensagemErro();
            document.getElementById("origem").value = "Buscando localização...";
            document.getElementById("btn-usar-localizacao").disabled = true;
            document.getElementById("origem").style.fontWeight = 'normal';


            if (!navigator.geolocation) {
                mostrarMensagemErro("❌ Seu navegador não suporta geolocalização.");
                document.getElementById("origem").value = "";
                document.getElementById("btn-usar-localizacao").disabled = false;
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                const latlng = { lat: lat, lng: lon };
                
                // 1. Tentar reverter as coordenadas para endereço de texto (Google Maps)
                const enderecoTexto = await reverseGeocode(latlng);
                
                // 2. Salvar as coordenadas reais nos campos hidden para usar no cálculo
                document.getElementById("coord-origem-lon").value = lon;
                document.getElementById("coord-origem-lat").value = lat;

                // 3. Limpar CEP/Número e popular campo de endereço
                document.getElementById("origem").value = `(LOCALIZAÇÃO ATUAL) ${enderecoTexto}`;
                document.getElementById("origem").style.fontWeight = 'bold';
                
            } catch (error) {
                let msg = "Erro ao obter localização. Verifique as permissões do navegador.";
                if (error.code === 1) {
                    msg = "Permissão de geolocalização negada pelo usuário.";
                } else if (error.code === 3) {
                    msg = "Tempo limite excedido para obter localização.";
                } else {
                    msg = `Falha na geolocalização: ${error.message}`;
                }
                mostrarMensagemErro(`❌ ${msg}`);
                document.getElementById("origem").value = "";
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
            } finally {
                document.getElementById("btn-usar-localizacao").disabled = false;
            }
        }

        async function buscarDestinoCEP() {
            if (!isGoogleMapsReady) {
                 mostrarMensagemErro("❌ Os serviços de mapa ainda não estão prontos.");
                 return;
            }
            limparMensagemErro();
            const cep = document.getElementById("cep-destino").value.replace(/\D/g, "");
            const numero = document.getElementById("numero-destino").value;
            if (!cep || !numero) {
                 mostrarMensagemErro("Preencha CEP e Número do destino para buscar o endereço.");
                 return;
            }
            try {
                // Força o uso do Geocoding por endereço (limpando coordenadas)
                document.getElementById("coord-destino-lon").value = "";
                document.getElementById("coord-destino-lat").value = "";
                document.getElementById("destino").style.fontWeight = 'normal';

                const end = await buscarEnderecoPorCEP(cep, numero);
                document.getElementById("destino").value = end;
                document.getElementById("destino").style.fontWeight = 'bold';
            } catch (e) {
                mostrarMensagemErro(`❌ Erro na busca de Destino: ${e.message}`);
                document.getElementById("destino").value = "";
            }
        }

        // --- SETUP INICIAL ---
        window.onload = function() {
            
            document.getElementById("btn-calcular").addEventListener("click", calcular);
            
            // Listeners para os botões de busca
            document.getElementById("btn-buscar-origem-cep").addEventListener("click", buscarOrigemCEP);
            document.getElementById("btn-usar-localizacao").addEventListener("click", usarLocalizacaoAtual);
            document.getElementById("btn-buscar-destino").addEventListener("click", buscarDestinoCEP);
            
            // Listeners para o Mapa
            document.getElementById("btn-map-origem").addEventListener("click", () => toggleMapSection('ORIGIN'));
            document.getElementById("btn-map-destino").addEventListener("click", () => toggleMapSection('DESTINATION'));
            
            // Listener para o Radio Group (Alternância de Origem)
            document.querySelectorAll('input[name="origin-choice"]').forEach(radio => {
                radio.addEventListener('change', (e) => toggleOriginInput(e.target.value));
            });
            
            // Inicializa o estado (mostra CEP por padrão)
            toggleOriginInput('cep');

            document.getElementById("tipo").addEventListener("change", e => {
                const showMoto = e.target.value === "15";
                document.getElementById("detalhes-moto").style.display = showMoto ? "block" : "none";
                
                if (!showMoto) {
                    document.getElementById("marca-moto").value = "";
                    document.getElementById("modelo-moto").value = "";
                    document.getElementById("cilindrada-moto").value = "";
                }
            });
            
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            // Injeção do script do Google Maps com a biblioteca 'places' e 'geometry'
            if (API_KEY_GOOGLE) {
                 const script = document.createElement('script');
                 script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY_GOOGLE}&libraries=geometry,places&callback=initMap`;
                 script.onerror = () => {
                     mostrarMensagemErro("❌ Falha no carregamento dos serviços de mapa. Tente recarregar a página."); 
                 };
                 document.head.appendChild(script);
            } else {
                 mostrarMensagemErro("❌ Chave de API de mapa não configurada. O cálculo não funcionará.");
            }
        };
    </script>
</head>
<body>
    <main class="container">
        <h1 class="logo-placeholder">🚚 Gbservice Reboque</h1>
        
        <div id="mensagem-erro" class="mensagem-erro" style="display: none;"></div>
        
        <!-- CAMPOS HIDDEN PARA SALVAR COORDENADAS -->
        <input type="hidden" id="coord-origem-lon" value="" />
        <input type="hidden" id="coord-origem-lat" value="" />
        <input type="hidden" id="coord-destino-lon" value="" />
        <input type="hidden" id="coord-destino-lat" value="" />

        <section class="section endereco-section">
            <h2>Local do Veículo (Origem)</h2>
            
            <div class="input-toggle">
                <label>Como deseja informar a Origem?</label>
                <div class="radio-group">
                    <input type="radio" id="choice-cep" name="origin-choice" value="cep" checked>
                    <label for="choice-cep">CEP / Endereço</label>
                    
                    <input type="radio" id="choice-geo" name="origin-choice" value="geo">
                    <label for="choice-geo">Localização Atual</label>
                </div>
            </div>

            <!-- BLOCO DE INPUT POR CEP/ENDEREÇO -->
            <div id="cep-input-block" class="input-block">
                <div class="form-group">
                    <label for="cep-origem">CEP:</label>
                    <input type="text" id="cep-origem" placeholder="Ex: 23560000" maxlength="8" autocomplete="postal-code" />
                </div>
                <div class="form-group">
                    <label for="numero-origem">Número:</label>
                    <input type="number" id="numero-origem" placeholder="Número do endereço" autocomplete="address-level1" />
                </div>
                <button id="btn-buscar-origem-cep" type="button">Buscar Endereço</button>
            </div>

            <!-- BLOCO DE INPUT POR GEOLOCALIZAÇÃO -->
            <div id="geo-input-block" class="input-block" style="display: none;">
                <button id="btn-usar-localizacao" type="button" style="background-color: #38a169; margin-bottom: 10px;">
                    Usar Minha Localização Atual
                </button>
            </div>
            
            <button id="btn-map-origem" type="button" style="background-color: #f7931e; margin-top: 15px; margin-bottom: 15px;">
                Selecionar no Mapa
            </button>
            
            <!-- Placeholder para o mapa de Origem (Ponto 1) -->
            <div id="origin-map-placeholder"></div>
            
            <!-- CAMPO DE ENDEREÇO RESULTANTE (comum aos métodos) -->
            <div class="form-group">
                <label for="origem">Endereço de Origem (Gerado automaticamente):</label>
                <input disabled type="text" id="origem" placeholder="Selecione a Origem (CEP/Geo/Mapa)" autocomplete="street-address" />
            </div>
        </section>

        <section class="section destino-section">
            <h2>Destino do Reboque</h2>
            <div class="form-group">
                <label for="cep-destino">CEP:</label>
                <input type="text" id="cep-destino" placeholder="Digite o CEP da rua de destino" maxlength="8" autocomplete="postal-code" />
            </div>
            <div class="form-group">
                <label for="numero-destino">Número:</label>
                <input type="number" id="numero-destino" placeholder="Número" autocomplete="address-level1" />
            </div>
            
            <button id="btn-buscar-destino" type="button" class="button-buscar">Buscar Endereço de Destino</button>
            
            <button id="btn-map-destino" type="button" style="background-color: #f7931e; margin-top: 15px; margin-bottom: 15px;">
                Selecionar no Mapa
            </button>
            
            <!-- Placeholder para o mapa de Destino (Ponto 1) -->
            <div id="destination-map-placeholder"></div>
            
            <div class="form-group">
                <label for="destino">Endereço de destino (Gerado automaticamente):</label>
                <input disabled type="text" id="destino" placeholder="Selecione o Destino (CEP/Mapa)" autocomplete="address-line1" />
            </div>
            
            <div class="form-group">
                <label for="tipo">Tipo de Veículo:</label>
                <select id="tipo" aria-label="Tipo de veículo">
                    <option value="" disabled selected>Selecione</option>
                    <option value="50">Carro</option>
                    <option value="15">Moto</option>
                </select>
            </div>
            <div id="detalhes-moto" style="display: none;">
                <div class="form-group">
                    <label for="marca-moto">Marca:</label>
                    <input type="text" id="marca-moto" placeholder="Ex.: Honda" />
                </div>
                <div class="form-group">
                    <label for="modelo-moto">Modelo:</label>
                    <input type="text" id="modelo-moto" placeholder="Ex.: CG Titan" />
                </div>
                <div class="form-group">
                    <label for="cilindrada-moto">Cilindrada:</label>
                    <input type="number" id="cilindrada-moto" placeholder="Ex.: 160" />
                </div>
            </div>
        </section>
        
        <!-- SEÇÃO DE INTERAÇÃO COM O MAPA (Esta seção será movida pelo JS) -->
        <section id="map-interaction-section" class="section" style="display: none;">
            <h2>📍 Seleção por Mapa</h2>
            <div class="map-controls">
                 <p id="map-status" class="map-status">Clique no mapa para definir o ponto.</p>
            </div>
            <div id="map-canvas"></div>
        </section>
        <!-- FIM SEÇÃO DE INTERAÇÃO COM O MAPA -->

        <section class="section acao-section">
            <button id="btn-calcular" type="button">Calcular valor</button>
        </section>

        <section class="section resultado-section" aria-live="polite" aria-atomic="true">
            <div id="resultado">Preencha todos os campos e clique em CALCULAR.</div>
        </section>

        <section class="section whatsapp-section">
            <button id="whatsapp-solicitar-btn" class="whatsapp-button" disabled>Solicitar reboque via WhatsApp</button>
        </section>
        <footer class="footer">
            <p>Desenvolvido por <strong>Natanael Costa</strong></p>
        </footer>
    </main>
</body>
</html>
