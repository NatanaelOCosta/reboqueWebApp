<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de Reboque</title>
    <style>
        /* Reset b√°sico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .container {
            background: white;
            max-width: 600px;
            width: 100%;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #444;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 5px;
        }

        /* Formul√°rio */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            user-select: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            outline-offset: 0;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
        }

        /* Bot√£o Padr√£o */
        button {
            cursor: pointer;
            background: #1a73e8;
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            transition: background-color 0.3s ease;
            user-select: none;
            margin-top: 5px;
        }

        button:hover,
        button:focus {
            background: #155ab6;
            outline: none;
        }
        
        /* Estiliza√ß√£o do Toggle de Escolha (CEP vs GEO) */
        .input-toggle {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .input-toggle > label {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #1a73e8;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            flex-grow: 1;
            text-align: center;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            background-color: white;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .radio-group input[type="radio"]:checked + label {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* Fim Estiliza√ß√£o Toggle */

        #resultado {
            font-weight: 700;
            white-space: pre-line;
            font-size: 1.1rem;
            padding: 15px 20px;
            background: #e1f0ff;
            border-radius: 8px;
            border: 1px solid #7ab8ff;
            min-height: 60px;
            color: #0d47a1;
        }
        
        #mensagem-erro {
            color: red; 
            margin-bottom: 10px; 
            padding: 15px; 
            border: 2px solid #f8d7da; 
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            font-weight: 600;
        }

        .whatsapp-button {
            background-color: #25D366; 
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            user-select: none;
        }

        .whatsapp-button:hover,
        .whatsapp-button:focus {
            background-color: #128C7E;
            outline: none;
        }

        #detalhes-moto {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .logo-placeholder {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 20px;
        }

        /* Estilo para a caixa de problemas */
        .troubleshooting {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #d6a100;
            background-color: #fffde7;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .troubleshooting h3 {
            color: #d6a100;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .troubleshooting ol {
            padding-left: 20px;
            margin-top: 5px;
        }
        .troubleshooting li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .troubleshooting strong {
            color: #0d47a1;
        }
        
        /* Responsividade */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            .radio-group label {
                flex-basis: 100%;
            }

            input[type="text"],
            input[type="number"],
            select,
            button {
                font-size: 1rem;
                padding: 10px 12px;
            }
        }
    </style>
    <script>
        // =================================================================
        // ATEN√á√ÉO: CHAVE DE API DO GOOGLE MAPS PLATFORM
        // Insira a sua chave aqui.
        // =================================================================
        const API_KEY_GOOGLE = "AIzaSyBwd9QQquprtp9WM-M3KlzXe6rOKAy41Ns"; // <<-- INSIRA SUA CHAVE AQUI -->>
        
        const enderecoBase = "R. Dom Jo√£o VI, 6 - Santa Cruz, Rio de Janeiro - RJ";
        const WHATSAPP_NUMBER = "5521999999999"; 

        // --- FUN√á√ïES DE ROBUSTEZ DE REDE (Retry com Backoff) ---
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function retryFetch(url, options = {}, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.ok) {
                        return response;
                    }
                    
                    if (i === maxRetries - 1) {
                        throw new Error(`Falha na requisi√ß√£o (Status: ${response.status} ${response.statusText}).`);
                    }

                } catch (error) {
                    // Erro de rede/conex√£o
                    console.error(`Tentativa ${i + 1} falhou (Erro de Rede/Conex√£o):`, error.message);
                    if (i === maxRetries - 1) {
                        throw new Error("Falha na requisi√ß√£o de rede ap√≥s m√∫ltiplas tentativas. Verifique sua conex√£o.");
                    }
                }
                
                const delay = Math.pow(2, i) * 1000; 
                console.log(`Aguardando ${delay / 1000}s antes de tentar novamente...`);
                await sleep(delay);
            }
        }
        // -------------------------------------
        
        function applyJitter(coords) {
            const [lat, lon] = coords;
            // Adiciona um pequeno "jitter" (varia√ß√£o) na longitude para garantir que a rota seja calculada.
            return [lat, lon + 0.000001]; 
        }

        async function buscarEnderecoPorCEP(cep, numero) {
            limparMensagemErro(); 

            // 1. Busca no ViaCEP (r√°pido para obter o texto do endere√ßo)
            const response = await retryFetch(`https://viacep.com.br/ws/${cep}/json/`);
            
            const data = await response.json();
            if (data.erro) throw new Error("CEP n√£o encontrado.");

            const enderecoCompleto = `${data.logradouro}, ${numero} - ${data.bairro}, ${data.localidade} - ${data.uf}`;
            
            // 2. Valida√ß√£o Geocoding (usando Google Maps)
            const coords = await geocode(enderecoCompleto);
            if (!coords) throw new Error("Endere√ßo inv√°lido ou n√£o reconhecido pelo Google Maps.");
            
            return enderecoCompleto;
        }

        /**
         * Realiza Geocodifica√ß√£o (Texto -> Coordenadas) usando Google Maps Geocoding API
         * Retorna [lat, lon]
         */
        async function geocode(endereco) {
            if (API_KEY_GOOGLE === "YOUR_GOOGLE_MAPS_API_KEY") {
                throw new Error("A chave de API n√£o foi configurada no c√≥digo.");
            }
            // Inclui o pa√≠s para melhorar a precis√£o no Brasil.
            const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(endereco)}&region=br&key=${API_KEY_GOOGLE}`;
            
            const response = await retryFetch(url);

            const data = await response.json();

            if (data.status !== 'OK' || !data.results?.length) {
                const erroMsg = data.error_message || data.status;
                throw new Error(`Geocoding (Google Maps) falhou. Status: ${erroMsg}. (Pode ser erro de chave/faturamento)`);
            }

            const location = data.results[0].geometry?.location;
            if (!location || typeof location.lat !== 'number' || typeof location.lng !== 'number') {
                 throw new Error("Coordenadas inv√°lidas retornadas pelo Google Maps.");
            }
            return [location.lat, location.lng]; // [lat, lon]
        }
        
        /**
         * Realiza Geocodifica√ß√£o Reversa (Coordenadas -> Texto) usando Google Maps Geocoding API
         * Retorna [lat, lon]
         */
        async function reverseGeocode(lat, lon) {
             if (API_KEY_GOOGLE === "YOUR_GOOGLE_MAPS_API_KEY") {
                throw new Error("A chave de API n√£o foi configurada no c√≥digo.");
            }

            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${API_KEY_GOOGLE}`;
            
            const response = await retryFetch(url);

            const data = await response.json();
            
            if (data.status !== 'OK' || !data.results?.length) {
                const erroMsg = data.error_message || data.status;
                throw new Error(`Geocoding Reverso (Google Maps) falhou. Status: ${erroMsg}. (Pode ser erro de chave/faturamento)`);
            }
            
            // Retorna o endere√ßo formatado mais preciso (primeiro resultado)
            const address = data.results[0].formatted_address;
            if (!address) throw new Error("N√£o foi poss√≠vel formatar o endere√ßo (Google Maps Reverse).");

            return address;
        }

        /**
         * Calcula a rota (dist√¢ncia) usando Google Maps Directions API
         * Ponto A e Ponto B devem ser [lat, lon]
         * Retorna dist√¢ncia em KM
         */
        async function rota(pontoA, pontoB) {
            if (API_KEY_GOOGLE === "YOUR_GOOGLE_MAPS_API_KEY") {
                throw new Error("A chave de API n√£o foi configurada no c√≥digo.");
            }
            if (!Array.isArray(pontoA) || !Array.isArray(pontoB)) throw new Error("Coordenadas inv√°lidas para a rota.");

            const origin = `${pontoA[0]},${pontoA[1]}`; // lat,lon
            const destination = `${pontoB[0]},${pontoB[1]}`; // lat,lon

            // Usamos mode=driving e avoid=tolls para uma rota de reboque
            const url = `https://maps.googleapis.com/maps/api/directions/json?origin=${origin}&destination=${destination}&mode=driving&avoid=tolls&key=${API_KEY_GOOGLE}`;

            const response = await retryFetch(url);

            const data = await response.json();
            
            if (data.status !== 'OK' || !data.routes?.[0]?.legs?.[0]?.distance?.value) {
                const erroMsg = data.error_message || data.status;
                throw new Error(`Directions (Google Maps) falhou. Status: ${erroMsg}.`);
            }

            // Dist√¢ncia √© em metros, convertemos para KM
            const distanciaMetros = data.routes[0].legs[0].distance.value;
            return distanciaMetros / 1000; // km
        }
        
        async function safeRota(pontoA, pontoB, isJittered) {
            const MIN_SAFE_DISTANCE_KM = 0.2; 
            
            try {
                const distance = await rota(pontoA, pontoB);
                
                if (isJittered && distance < 0.001) { 
                    console.warn("Dist√¢ncia calculada foi zero/quase zero mesmo com Jitter. Aplicando fallback.");
                    return { distance: MIN_SAFE_DISTANCE_KM, fallback: true };
                }
                
                return { distance, fallback: false };
            } catch (error) {
                console.warn(`[DEBUG] Rota falhou. Aplicando fallback para evitar travamento. Erro: ${error.message}`);
                // O erro original √© propagado para o bloco principal de catch para diagn√≥stico.
                throw error; 
            }
        }

        let valorTotal = 0;
        
        // Coords String agora mostra [Lat, Lon]
        const coordsString = (coords) => `[Lat: ${coords[0].toFixed(5)}, Lon: ${coords[1].toFixed(5)}]`;


        async function calcular() {
            limparMensagemErro(); 
            
            let enderecoOrigemCompleto;
            let enderecoDestinoCompleto;
            let tipoVeiculo;
            let cilindrada = 0; 
            let coordOrigem;

            try {
                document.getElementById("resultado").innerText = "Calculando...";
                
                // 1. Validar e Obter Inputs B√°sicos
                tipoVeiculo = document.getElementById("tipo").value;
                if (!tipoVeiculo) throw new Error("Selecione o tipo de ve√≠culo.");

                enderecoOrigemCompleto = document.getElementById("origem").value; 
                enderecoDestinoCompleto = document.getElementById("destino").value; 

                if (!enderecoOrigemCompleto) throw new Error("Defina o endere√ßo de Origem (CEP ou Localiza√ß√£o Atual) antes de calcular.");
                if (!enderecoDestinoCompleto) throw new Error("Busque o endere√ßo de Destino primeiro.");

                if (tipoVeiculo === "15") {
                    cilindrada = parseInt(document.getElementById("cilindrada-moto").value);
                    if (isNaN(cilindrada)) throw new Error("Informe a cilindrada da moto.");
                }
                
                // 2. Determinar Coordenadas de Origem
                const savedLon = parseFloat(document.getElementById("coord-origem-lon").value);
                const savedLat = parseFloat(document.getElementById("coord-origem-lat").value);
                
                if (!isNaN(savedLon) && !isNaN(savedLat)) {
                    // ORIGEM VEIO DA GEOLOCALIZA√á√ÉO
                    coordOrigem = [savedLat, savedLon]; // [lat, lon]
                } else {
                    // ORIGEM VEIO DO CEP/BUSCA (PRECISA DE FORWARD GEOCODING - Google)
                    const cepOrigem = document.getElementById("cep-origem").value.replace(/\D/g, "");
                    const numeroOrigem = document.getElementById("numero-origem").value;
                    const geocodeQueryOrigem = `${enderecoOrigemCompleto}, N√∫mero ${numeroOrigem}, CEP ${cepOrigem}`;
                    
                    coordOrigem = await geocode(geocodeQueryOrigem); // [lat, lon]
                }

                // 3. Calcular Taxa Fixa
                let taxa = 0;
                if (tipoVeiculo === "50") taxa = 50;
                else if (tipoVeiculo === "15") {
                    if (cilindrada <= 160) taxa = 15;
                    else if (cilindrada <= 250) taxa = 25;
                    else if (cilindrada <= 499) taxa = 35;
                    else if (cilindrada <= 999) taxa = 50;
                    else taxa = 100;
                }

                // 4. Geocodificar Base e Destino (Google Maps em paralelo)
                const cepDestino = document.getElementById("cep-destino").value.replace(/\D/g, "");
                const numeroDestino = document.getElementById("numero-destino").value;
                const geocodeQueryDestino = `${enderecoDestinoCompleto}, N√∫mero ${numeroDestino}, CEP ${cepDestino}`;
                
                const [coordBase, coordDestino] = await Promise.all([
                    geocode(enderecoBase),
                    geocode(geocodeQueryDestino),
                ]); // Ambas s√£o [lat, lon]

                // 5. MONTAR PARES DE ROTA COM JITTER SELETIVO
                let baseToOrigem = [coordBase, coordOrigem];
                let origemToDestino = [coordOrigem, coordDestino];
                let destinoToBase = [coordDestino, coordBase];
                let jitterApplied = { 1: false, 2: false, 3: false };

                // Aplica Jitter se a origem ou destino for a Base (ou se origem/destino forem o mesmo ponto)
                if (JSON.stringify(coordBase) === JSON.stringify(coordOrigem)) {
                    baseToOrigem = [coordBase, applyJitter(coordOrigem)];
                    jitterApplied[1] = true;
                }
                if (JSON.stringify(coordOrigem) === JSON.stringify(coordDestino)) {
                    origemToDestino = [coordOrigem, applyJitter(coordDestino)];
                    jitterApplied[2] = true;
                }
                if (JSON.stringify(coordDestino) === JSON.stringify(coordBase)) {
                    destinoToBase = [coordDestino, applyJitter(coordBase)];
                    jitterApplied[3] = true;
                }

                // 6. Calcular Rotas (Google Maps em paralelo)
                // Se safeRota falhar, a exce√ß√£o √© propagada para o bloco catch principal
                const promiseDist1 = safeRota(baseToOrigem[0], baseToOrigem[1], jitterApplied[1]);
                const promiseDist2 = safeRota(origemToDestino[0], origemToDestino[1], jitterApplied[2]);
                const promiseDist3 = safeRota(destinoToBase[0], destinoToBase[1], jitterApplied[3]);

                const [res1, res2, res3] = await Promise.all([
                    promiseDist1,
                    promiseDist2,
                    promiseDist3,
                ]);
                
                const dist1 = res1.distance;
                const dist2 = res2.distance;
                const dist3 = res3.distance;
                
                const fallback1 = res1.fallback;
                const fallback2 = res2.fallback;
                const fallback3 = res3.fallback;

                // 7. Apresentar Resultado
                const distanciaTotalKm = dist1 + dist2 + dist3;
                const valorKm = distanciaTotalKm * 1.7; // R$ 1,70 por km
                valorTotal = valorKm + taxa;
                
                const detalhesMoto = tipoVeiculo === "15" ? 
                    ` (Cilindrada: ${document.getElementById("cilindrada-moto").value}cc)` : '';
                
                const notaFallback = "(Dist√¢ncia m√≠nima de 0.2 km for√ßada devido a falha na rota)";
                const textoDist1 = `Base ‚Üí Origem: ${dist1.toFixed(2)} km${fallback1 ? ` ${notaFallback}` : ''}`;
                const textoDist2 = `Origem ‚Üí Destino: ${dist2.toFixed(2)} km${fallback2 ? ` ${notaFallback}` : ''}`;
                const textoDist3 = `Destino ‚Üí Base: ${dist3.toFixed(2)} km${fallback3 ? ` ${notaFallback}` : ''}`;
                
                document.getElementById("resultado").innerText =
                    `API Utilizada: Google Maps Platform\n\n` +
                    `üìç Coordenadas Utilizadas (Lat, Lon):\n` +
                    `Base: ${coordsString(coordBase)}\n` +
                    `Origem: ${coordsString(coordOrigem)}\n` +
                    `Destino: ${coordsString(coordDestino)}\n\n` +
                    `Detalhes da Rota:\n` +
                    `${textoDist1}\n` +
                    `${textoDist2}\n` +
                    `${textoDist3}\n\n` +
                    `Dist√¢ncia Total (ida e volta): ${distanciaTotalKm.toFixed(2)} km\n` +
                    `Custo por KM (R$ 1,70/km): R$ ${valorKm.toFixed(2)}\n` +
                    `Taxa Fixa (Ve√≠culo: ${tipoVeiculo === '50' ? 'Carro' : 'Moto'}${detalhesMoto}): R$ ${taxa.toFixed(2)}\n` +
                    `\nüí∞ VALOR TOTAL ESTIMADO: R$ ${valorTotal.toFixed(2)}`;
                
                updateWhatsappButton(enderecoOrigemCompleto, enderecoDestinoCompleto, valorTotal);
                
            } catch (error) {
                console.error("Erro no c√°lculo:", error);
                
                let userMessage = error.message;
                const isApiKeyError = userMessage.includes("Status: REQUEST_DENIED") || userMessage.includes("API_KEY");
                const isRefererError = userMessage.includes("API keys with referer restrictions cannot be used with this API.");

                if (isRefererError) {
                    userMessage = `Restri√ß√£o de Referer HTTP. SOLU√á√ÉO: Remova a restri√ß√£o de Referer da sua chave no Google Cloud Console (veja o checklist abaixo).`;
                } else if (isApiKeyError) {
                    userMessage = `Chave de API inv√°lida ou faturamento desativado. Por favor, verifique o checklist de problemas abaixo.`;
                } else if (userMessage.includes("Falha na requisi√ß√£o")) {
                    userMessage = `Falha de rede ao acessar o Google Maps. Verifique sua conex√£o.`;
                }

                mostrarMensagemErro(`‚ùå Erro: ${userMessage}`); 
                document.getElementById("resultado").innerText = "‚ùå Erro no c√°lculo. Consulte a mensagem acima e o checklist abaixo.";
                document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            }
        }

        function mostrarMensagemErro(msg) {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "block";
            div.innerHTML = `<strong>${msg}</strong>`;
        }

        function limparMensagemErro() {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "none";
            div.textContent = "";
        }

        function updateWhatsappButton(origem, destino, valor) {
            const btn = document.getElementById("whatsapp-solicitar-btn");
            const msg = encodeURIComponent(
                `Ol√°! Gostaria de solicitar um reboque.\n\n` +
                `üìç Origem: ${origem}\n` +
                `üèÅ Destino: ${destino}\n\n` +
                `üíµ Valor estimado: R$ ${valor.toFixed(2)}\n\n` +
                `Por favor, confirme a disponibilidade.`
            );
            btn.removeAttribute('disabled');
            btn.onclick = () => {
                window.open(`https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${msg}`, '_blank');
            };
        }

        // === FLUXO DE BUSCA DE ENDERE√áO COM TOGGLE ===
        
        function toggleOriginInput(choice) {
            limparMensagemErro();
            const cepBlock = document.getElementById("cep-input-block");
            const geoBlock = document.getElementById("geo-input-block");
            const origemField = document.getElementById("origem");

            if (choice === 'cep') {
                cepBlock.style.display = 'block';
                geoBlock.style.display = 'none';
                
                // Limpar dados de Geolocaliza√ß√£o (para evitar conflito no c√°lculo)
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
                origemField.value = "";
                origemField.placeholder = "Endere√ßo gerado ap√≥s busca por CEP";
                
            } else if (choice === 'geo') {
                cepBlock.style.display = 'none';
                geoBlock.style.display = 'block';
                
                // Limpar dados de CEP
                document.getElementById("cep-origem").value = "";
                document.getElementById("numero-origem").value = "";
                origemField.value = "";
                origemField.placeholder = "Endere√ßo gerado ap√≥s obter Localiza√ß√£o Atual";
            }
        }
        
        async function buscarOrigemCEP() {
            limparMensagemErro();
            const cep = document.getElementById("cep-origem").value.replace(/\D/g, "");
            const numero = document.getElementById("numero-origem").value;
            if (!cep || !numero) {
                 mostrarMensagemErro("Preencha CEP e N√∫mero para buscar o endere√ßo.");
                 return;
            }
            try {
                // Assegura que as coordenadas est√£o limpas para for√ßar o Geocoding
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
                
                const end = await buscarEnderecoPorCEP(cep, numero);
                document.getElementById("origem").value = end;
            } catch (e) {
                mostrarMensagemErro(`‚ùå Erro na busca de Origem: ${e.message}`);
                document.getElementById("origem").value = "";
            }
        }

        async function usarLocalizacaoAtual() {
            limparMensagemErro();
            document.getElementById("origem").value = "Buscando localiza√ß√£o...";
            document.getElementById("btn-usar-localizacao").disabled = true;

            if (!navigator.geolocation) {
                mostrarMensagemErro("Seu navegador n√£o suporta geolocaliza√ß√£o.");
                document.getElementById("origem").value = "";
                document.getElementById("btn-usar-localizacao").disabled = false;
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // 1. Tentar reverter as coordenadas para endere√ßo de texto (Google Maps)
                const enderecoTexto = await reverseGeocode(lat, lon);
                
                // 2. Salvar as coordenadas reais nos campos hidden para usar no c√°lculo
                document.getElementById("coord-origem-lon").value = lon;
                document.getElementById("coord-origem-lat").value = lat;

                // 3. Limpar CEP/N√∫mero e popular campo de endere√ßo
                document.getElementById("origem").value = `(LOCALIZA√á√ÉO ATUAL) ${enderecoTexto}`;
                
            } catch (error) {
                let msg = "Erro ao obter localiza√ß√£o. Verifique as permiss√µes do navegador.";
                if (error.code === 1) {
                    msg = "Permiss√£o de geolocaliza√ß√£o negada pelo usu√°rio.";
                } else if (error.code === 3) {
                    msg = "Tempo limite excedido para obter localiza√ß√£o.";
                } else {
                    msg = `Falha na geolocaliza√ß√£o ou no reconhecimento do endere√ßo: ${error.message}`;
                }
                mostrarMensagemErro(`‚ùå ${msg}`);
                document.getElementById("origem").value = "";
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
            } finally {
                document.getElementById("btn-usar-localizacao").disabled = false;
            }
        }

        async function buscarDestinoCEP() {
            limparMensagemErro();
            const cep = document.getElementById("cep-destino").value.replace(/\D/g, "");
            const numero = document.getElementById("numero-destino").value;
            if (!cep || !numero) {
                 mostrarMensagemErro("Preencha CEP e N√∫mero do destino para buscar o endere√ßo.");
                 return;
            }
            try {
                const end = await buscarEnderecoPorCEP(cep, numero);
                document.getElementById("destino").value = end;
            } catch (e) {
                mostrarMensagemErro(`‚ùå Erro na busca de Destino: ${e.message}`);
                document.getElementById("destino").value = "";
            }
        }

        // === SETUP INICIAL ===
        window.onload = function() {
            
            document.getElementById("btn-calcular").addEventListener("click", calcular);
            
            // Listeners para os bot√µes de busca
            document.getElementById("btn-buscar-origem-cep").addEventListener("click", buscarOrigemCEP);
            document.getElementById("btn-usar-localizacao").addEventListener("click", usarLocalizacaoAtual);
            document.getElementById("btn-buscar-destino").addEventListener("click", buscarDestinoCEP);
            
            // Listener para o Radio Group (Altern√¢ncia)
            document.querySelectorAll('input[name="origin-choice"]').forEach(radio => {
                radio.addEventListener('change', (e) => toggleOriginInput(e.target.value));
            });
            
            // Inicializa o estado (mostra CEP por padr√£o)
            toggleOriginInput('cep');

            document.getElementById("tipo").addEventListener("change", e => {
                const showMoto = e.target.value === "15";
                document.getElementById("detalhes-moto").style.display = showMoto ? "block" : "none";
                
                if (!showMoto) {
                    document.getElementById("marca-moto").value = "";
                    document.getElementById("modelo-moto").value = "";
                    document.getElementById("cilindrada-moto").value = "";
                }
            });
            
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            if (API_KEY_GOOGLE === "YOUR_GOOGLE_MAPS_API_KEY") {
                mostrarMensagemErro("‚ö†Ô∏è ATEN√á√ÉO: A Chave de API do Google Maps est√° como placeholder. Por favor, edite o arquivo e insira sua chave no campo 'API_KEY_GOOGLE' no topo do bloco <script>.");
            }
            
            // Atualiza o display da chave
            const apiKeyDisplay = document.getElementById("api-key-display-value");
            apiKeyDisplay.value = API_KEY_GOOGLE.substring(0, 4) + "..." + API_KEY_GOOGLE.substring(API_KEY_GOOGLE.length - 4);
            if (API_KEY_GOOGLE === "YOUR_GOOGLE_MAPS_API_KEY") {
                apiKeyDisplay.value = "Chave n√£o configurada";
            }
        };
    </script>
</head>
<body>
    <main class="container">
        <h1 class="logo-placeholder">üöö Gbservice Reboque</h1>
        
        <div class="form-group">
            <label for="api-key-display-value">Chave de API (4 d√≠gitos iniciais/finais):</label>
            <input type="text" id="api-key-display-value" value="" style="background-color: #e1f0ff; color: #0d47a1; font-weight: bold;"/>
        </div>

        <div id="mensagem-erro" class="mensagem-erro" style="display: none;"></div>
        
        <!-- CAMPOS HIDDEN PARA SALVAR COORDENADAS DA GEOLOCALIZA√á√ÉO -->
        <input type="hidden" id="coord-origem-lon" value="" />
        <input type="hidden" id="coord-origem-lat" value="" />

        <section class="section endereco-section">
            <h2>Local do Ve√≠culo (Origem)</h2>
            
            <div class="input-toggle">
                <label>Como deseja informar a Origem?</label>
                <div class="radio-group">
                    <input type="radio" id="choice-cep" name="origin-choice" value="cep" checked>
                    <label for="choice-cep">CEP / Endere√ßo</label>
                    
                    <input type="radio" id="choice-geo" name="origin-choice" value="geo">
                    <label for="choice-geo">Localiza√ß√£o Atual</label>
                </div>
            </div>

            <!-- BLOCO DE INPUT POR CEP/ENDERE√áO -->
            <div id="cep-input-block" class="input-block">
                <div class="form-group">
                    <label for="cep-origem">CEP:</label>
                    <input type="text" id="cep-origem" placeholder="Ex: 23560000" maxlength="8" autocomplete="postal-code" />
                </div>
                <div class="form-group">
                    <label for="numero-origem">N√∫mero:</label>
                    <input type="number" id="numero-origem" placeholder="N√∫mero do endere√ßo" autocomplete="address-level1" />
                </div>
                <button id="btn-buscar-origem-cep" type="button">Buscar Endere√ßo</button>
            </div>

            <!-- BLOCO DE INPUT POR GEOLOCALIZA√á√ÉO -->
            <div id="geo-input-block" class="input-block" style="display: none;">
                <button id="btn-usar-localizacao" type="button" style="background-color: #38a169; margin-bottom: 10px;">
                    Usar Minha Localiza√ß√£o Atual
                </button>
            </div>
            
            <!-- CAMPO DE ENDERE√áO RESULTANTE (comum aos dois m√©todos) -->
            <div class="form-group">
                <label for="origem">Endere√ßo completo (Gerado automaticamente):</label>
                <input disabled type="text" id="origem" placeholder="Endere√ßo gerado ap√≥s busca ou localiza√ß√£o" autocomplete="street-address" />
            </div>
        </section>

        <section class="section destino-section">
            <h2>Destino do Reboque</h2>
            <div class="form-group">
                <label for="cep-destino">CEP:</label>
                <input type="text" id="cep-destino" placeholder="Digite o CEP da rua de destino" maxlength="8" autocomplete="postal-code" />
            </div>
            <div class="form-group">
                <label for="numero-destino">N√∫mero:</label>
                <input type="number" id="numero-destino" placeholder="N√∫mero" autocomplete="address-level1" />
            </div>
            
            <button id="btn-buscar-destino" type="button" class="button-buscar">Buscar Endere√ßo de Destino</button>
            
            <div class="form-group">
                <label for="destino">Endere√ßo de destino completo:</label>
                <input disabled type="text" id="destino" placeholder="Endere√ßo gerado automaticamente" autocomplete="address-line1" />
            </div>
            <div class="form-group">
                <label for="tipo">Tipo de Ve√≠culo:</label>
                <select id="tipo" aria-label="Tipo de ve√≠culo">
                    <option value="" disabled selected>Selecione</option>
                    <option value="50">Carro</option>
                    <option value="15">Moto</option>
                </select>
            </div>
            <div id="detalhes-moto" style="display: none;">
                <div class="form-group">
                    <label for="marca-moto">Marca:</label>
                    <input type="text" id="marca-moto" placeholder="Ex.: Honda" />
                </div>
                <div class="form-group">
                    <label for="modelo-moto">Modelo:</label>
                    <input type="text" id="modelo-moto" placeholder="Ex.: CG Titan" />
                </div>
                <div class="form-group">
                    <label for="cilindrada-moto">Cilindrada:</label>
                    <input type="number" id="cilindrada-moto" placeholder="Ex.: 160" />
                </div>
            </div>
        </section>

        <section class="section acao-section">
            <button id="btn-calcular" type="button">Calcular valor</button>
        </section>

        <section class="section resultado-section" aria-live="polite" aria-atomic="true">
            <div id="resultado">Preencha todos os campos e clique em CALCULAR.</div>
            <div class="troubleshooting">
                <h3>üõ†Ô∏è Solu√ß√£o de Problemas com API do Google Maps</h3>
                <p>Se o erro for sobre **Referer/Restri√ß√£o** ou **REQUEST_DENIED**, verifique os seguintes 4 pontos no seu **Google Cloud Console**:</p>
                <ol>
                    <li><strong>Chave (API Key):</strong> Certifique-se de que a chave inserida no c√≥digo √© exatamente a mesma que voc√™ gerou.</li>
                    <li><strong>APIs Ativadas:</strong> Confirme que as seguintes APIs est√£o **ativadas** no seu projeto:
                        <ul>
                            <li>‚úÖ **Geocoding API**</li>
                            <li>‚úÖ **Directions API**</li>
                        </ul>
                    </li>
                    <li><strong>Faturamento (Billing):</strong> O faturamento (cart√£o de cr√©dito) precisa estar **ativado** no projeto. O Google s√≥ cobra se voc√™ exceder o cr√©dito mensal de \$200 USD.</li>
                    <li><strong>üî¥ Restri√ß√µes de Chave (MAIS PROV√ÅVEL):</strong> Se a chave tem restri√ß√£o de Referer HTTP, ela n√£o funciona em ambientes sandbox. Para testes, mude a restri√ß√£o de chave para **Nenhuma** (sem restri√ß√£o) ou restrinja apenas por API (item 2). 
                        <br/>**Se for usar restri√ß√£o HTTP Referer, adicione `*` (asterisco) para permitir qualquer URL temporariamente.**</li>
                </ol>
            </div>
        </section>

        <section class="section whatsapp-section">
            <button id="whatsapp-solicitar-btn" class="whatsapp-button" disabled>Solicitar reboque via WhatsApp</button>
        </section>
        <footer class="footer">
            <p>Desenvolvido por <strong>Natanael Costa</strong></p>
        </footer>
    </main>
</body>
</html>
