<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de Reboque Google Maps (Autocomplete e Número)</title>
    <style>
        /* Reset básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .container {
            background: white;
            max-width: 600px;
            width: 100%;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.1);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #444;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 5px;
        }

        /* Formulário */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            user-select: none;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            outline-offset: 0;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
        }

        /* Botão Padrão */
        button {
            cursor: pointer;
            background: #1a73e8;
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            transition: background-color 0.3s ease;
            user-select: none;
            margin-top: 5px;
        }

        button:hover,
        button:focus {
            background: #155ab6;
            outline: none;
        }
        
        /* Estilização do Toggle de Escolha (Aba/Botão) */
        .input-toggle {
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .input-toggle > label {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #444;
            font-weight: bold;
        }

        .radio-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f9f9f9;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            flex-grow: 1;
            text-align: center;
            padding: 12px 10px;
            cursor: pointer;
            background-color: transparent;
            transition: all 0.2s ease;
            font-weight: 600;
            margin-bottom: 0;
            border-right: 1px solid #eee;
        }

        .radio-group label:last-child {
             border-right: none;
        }

        .radio-group input[type="radio"]:checked + label {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        /* Fim Estilização Toggle */

        /* Estilos do Mapa */
        #map-canvas {
            height: 300px; 
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #e9e9e9;
        }
        
        .map-controls {
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 15px; /* Adiciona espaçamento acima dos controles */
            margin-bottom: 0;
        }

        .map-status {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            color: #d9480f; /* Laranja para foco no mapa */
        }
        
        #resultado {
            font-weight: 700;
            white-space: pre-line;
            font-size: 1.1rem;
            padding: 15px 20px;
            background: #e1f0ff;
            border-radius: 8px;
            border: 1px solid #7ab8ff;
            min-height: 60px;
            color: #0d47a1;
        }
        
        #mensagem-erro {
            color: red; 
            margin-bottom: 10px; 
            padding: 15px; 
            border: 2px solid #f8d7da; 
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            font-weight: 600;
        }

        .whatsapp-button {
            background-color: #25D366; 
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            width: 100%;
            margin-top: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            user-select: none;
        }

        .whatsapp-button:hover,
        .whatsapp-button:focus {
            background-color: #128C7E;
            outline: none;
        }
        
        /* Estilo do botão de confirmação do mapa */
        #btn-confirmar-mapa {
            background-color: #38a169; /* Verde para confirmação */
        }
        #btn-confirmar-mapa:hover {
            background-color: #277e53;
        }

        #detalhes-moto {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .logo-placeholder {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 20px;
        }
        
        /* Responsividade */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            .radio-group label {
                flex-basis: 45%; /* Ajuste para caber 2 ou 3 opções */
                font-size: 0.9rem;
            }

            input[type="text"],
            input[type="number"],
            select,
            button {
                font-size: 1rem;
                padding: 10px 12px;
            }
        }
    </style>
    <script>
        // =================================================================
        // ATENÇÃO: CHAVE DE API DO GOOGLE MAPS
        // =================================================================
        const API_KEY_GOOGLE = "AIzaSyBwd9QQquprtp9WM-M3KlzXe6rOKAy41Ns";
        
        // Coordenadas da Base (R. Dom João VI, 6 - Santa Cruz, RJ)
        const BASE_ADDRESS = { lat: -22.923831, lng: -43.682701 };
        const WHATSAPP_NUMBER = "552141014470"; 
        
        // Variáveis globais para os serviços do Google Maps
        let geocoder;
        let directionsService;
        let map;
        let originMarker, destinationMarker;
        let isGoogleMapsReady = false;
        let currentMapMode = null; // 'ORIGIN' ou 'DESTINATION'
        const RIO_CENTER = { lat: -22.9068, lng: -43.1729 }; // Centro do Rio de Janeiro

        // Função de callback chamada quando o script do Google Maps é carregado
        function initMap() {
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            isGoogleMapsReady = true;
            console.log("Serviços do Google Maps inicializados.");
            
            // Inicialização do mapa (oculto inicialmente)
            const mapCanvas = document.getElementById('map-canvas');
            if(mapCanvas) {
                map = new google.maps.Map(mapCanvas, {
                    center: RIO_CENTER,
                    zoom: 10,
                    fullscreenControl: false,
                    streetViewControl: false,
                    gestureHandling: 'greedy' 
                });

                // Marcador de Origem (Vermelho)
                originMarker = new google.maps.Marker({
                    map: map,
                    position: BASE_ADDRESS, 
                    icon: { 
                        url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" 
                    }
                });
                
                // Marcador de Destino (Azul)
                destinationMarker = new google.maps.Marker({
                    map: map,
                    position: RIO_CENTER, 
                    icon: { 
                        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" 
                    }
                });

                originMarker.setVisible(false);
                destinationMarker.setVisible(false);

                // Listener de clique no mapa
                map.addListener('click', handleMapClick);
            }
            
            // --- IMPLEMENTAÇÃO DO AUTOCOMPLETE ---
            
            // 1. Autocomplete Origem
            const inputOrigemAuto = document.getElementById('input-endereco-origem');
            // Restringe a busca a endereços
            const autocompleteOrigem = new google.maps.places.Autocomplete(inputOrigemAuto, {
                componentRestrictions: { country: "br" }, 
                fields: ["geometry", "formatted_address"],
                types: ["address"] 
            });
            autocompleteOrigem.addListener('place_changed', () => handleAutocompletePlaceChanged(autocompleteOrigem, 'ORIGIN'));

            // 2. Autocomplete Destino
            const inputDestinoAuto = document.getElementById('input-endereco-destino');
            const autocompleteDestino = new google.maps.places.Autocomplete(inputDestinoAuto, {
                componentRestrictions: { country: "br" },
                fields: ["geometry", "formatted_address"],
                types: ["address"] 
            });
            autocompleteDestino.addListener('place_changed', () => handleAutocompletePlaceChanged(autocompleteDestino, 'DESTINATION'));
            
            // **IMPORTANTE**: Inicializa a visibilidade dos blocos AGORA que os marcadores existem.
            toggleOriginInput('auto'); 
            toggleDestinationInput('auto');
        }
        
        // --- FUNÇÕES DE LIMPEZA E AVISO ---

        function mostrarMensagemErro(msg) {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "block";
            div.innerHTML = `<strong>${msg}</strong>`;
        }

        function limparMensagemErro() {
            const div = document.getElementById("mensagem-erro");
            div.style.display = "none";
            div.textContent = "";
        }
        
        // --- FUNÇÃO PARA RESETAR O FORMULÁRIO ---
        function resetForm() {
            // 1. Reset input fields
            document.getElementById("origem").value = "";
            document.getElementById("destino").value = "";
            
            // Novos inputs de número do Autocomplete
            document.getElementById("numero-origem-auto").value = "";
            document.getElementById("input-endereco-origem").value = ""; 
            
            document.getElementById("numero-destino-auto").value = "";
            document.getElementById("input-endereco-destino").value = ""; 

            document.getElementById("marca-moto").value = "";
            document.getElementById("modelo-moto").value = "";
            document.getElementById("cilindrada-moto").value = "";
            document.getElementById("tipo").selectedIndex = 0; // Reset vehicle type
            
            // 2. Reset hidden coordinates
            document.getElementById("coord-origem-lon").value = "";
            document.getElementById("coord-origem-lat").value = "";
            document.getElementById("coord-destino-lon").value = "";
            document.getElementById("coord-destino-lat").value = "";

            // 3. Reset UI feedback
            document.getElementById("resultado").innerText = "Preencha todos os campos e clique em CALCULAR.";
            document.getElementById("origem").style.fontWeight = 'normal';
            document.getElementById("destino").style.fontWeight = 'normal';
            document.getElementById("detalhes-moto").style.display = "none";
            
            // 4. Hide status/action buttons
            document.getElementById("whatsapp-container").style.display = 'none';
            document.getElementById("nova-consulta-container").style.display = 'none';
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            // 5. Hide error messages
            limparMensagemErro();

            // 6. Reset map modes and visibility
            document.getElementById("map-interaction-section").style.display = 'none';
            currentMapMode = null;
            if (originMarker) originMarker.setVisible(false);
            if (destinationMarker) destinationMarker.setVisible(false);
            
            // 7. Reset radio selections to default (auto) and apply toggle
            document.getElementById("choice-origem-auto").checked = true;
            document.getElementById("choice-dest-auto").checked = true;
            toggleOriginInput('auto'); 
            toggleDestinationInput('auto'); 
            
            // 8. Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        // --- FUNÇÕES DE UTILIDADE ---
        
        function updateWhatsappButton(origem, destino, valor) {
            const btn = document.getElementById("whatsapp-solicitar-btn");
            // 1. Torna o container do WhatsApp visível
            document.getElementById("whatsapp-container").style.display = 'block'; 
            
            const msg = encodeURIComponent(
                `Olá! Gostaria de solicitar um reboque.\n\n` +
                `📍 Origem: ${origem}\n` +
                `🏁 Destino: ${destino}\n\n` +
                `💵 Valor estimado: R$ ${valor.toFixed(2)}\n\n` +
                `Por favor, confirme a disponibilidade.`
            );
            btn.removeAttribute('disabled');
            btn.onclick = () => {
                window.open(`https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${msg}`, '_blank');
            };
        }
        
        // --- FUNÇÕES DE BUSCA/GEOCODING (Google Maps) ---
        
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK') {
                        // Retorna o objeto LatLng e o endereço formatado
                        resolve({ 
                            location: results[0].geometry.location,
                            formatted_address: results[0].formatted_address
                        });
                    } else if (status === 'ZERO_RESULTS') {
                        reject(new Error(`Endereço não encontrado: "${address}"`));
                    } else {
                        reject(new Error(`Falha na busca do endereço com status: ${status}.`));
                    }
                });
            });
        }
        
        function reverseGeocode(latlng) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'location': latlng }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].formatted_address);
                    } else if (status === 'ZERO_RESULTS') {
                        resolve(`Localização desconhecida: (${latlng.lat()}, ${latlng.lng()})`);
                    } else {
                        reject(new Error(`Falha no Geocoding Reverso com status: ${status}`));
                    }
                });
            });
        }

        
        // --- FUNÇÃO DE AUTOCOMPLETE PLACE CHANGED ---
        function handleAutocompletePlaceChanged(autocomplete, mode) {
            const place = autocomplete.getPlace();
            
            if (!place.geometry) {
                mostrarMensagemErro(`❌ Não foi possível encontrar a geometria para o endereço selecionado.`);
                return;
            }
            
            const lat = place.geometry.location.lat();
            const lon = place.geometry.location.lng();
            const address = place.formatted_address;
            
            let addressField, coordLatField, coordLonField;

            if (mode === 'ORIGIN') {
                addressField = document.getElementById('origem');
                coordLatField = document.getElementById('coord-origem-lat');
                coordLonField = document.getElementById('coord-origem-lon');
                // Limpa o campo de número do Autocomplete (se tiver algum valor parcial)
                document.getElementById("numero-origem-auto").value = ""; 
                
            } else { // DESTINATION
                addressField = document.getElementById('destino');
                coordLatField = document.getElementById('coord-destino-lat');
                coordLonField = document.getElementById('coord-destino-lon');
                 document.getElementById("numero-destino-auto").value = "";
            }

            // Define as coordenadas definitivas (o cálculo usará estas)
            coordLatField.value = lat;
            coordLonField.value = lon;
            
            // Atualiza o campo principal com o endereço formatado (SEM O NÚMERO)
            addressField.value = `${address} (AUTOCOMPLETADO)`;
            addressField.style.fontWeight = 'bold';
            
            // Limpa o campo Autocomplete de rua após a seleção para evitar confusão no input principal
            autocomplete.get('input').value = ""; 

            // Limpa qualquer erro
            limparMensagemErro();
        }

        // --- FUNÇÃO PRINCIPAL DE ROTA (Google Maps) ---
        
        function getDistance(origin, destination) {
             return new Promise((resolve, reject) => {
                const request = {
                    origin: origin,       
                    destination: destination, 
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC 
                };
                
                directionsService.route(request, (response, status) => {
                    if (status === 'OK') {
                        const route = response.routes[0];
                        // O Directions API retorna a distância em metros
                        const distanceMeters = route.legs[0].distance.value; 
                        resolve(distanceMeters / 1000); // Retorna em KM
                    } else if (status === 'ZERO_RESULTS' || status === 'NOT_FOUND') {
                        reject(new Error(`Rota não encontrada (Status: ${status}).`));
                    } else {
                        reject(new Error(`Falha ao calcular rota: ${status}`));
                    }
                });
            });
        }

        // --- FUNÇÃO DE CÁLCULO GERAL ---

        async function calcular() {
            limparMensagemErro(); 
            
            // Oculta os botões de ação enquanto calcula
            document.getElementById("whatsapp-container").style.display = 'none';
            document.getElementById("nova-consulta-container").style.display = 'none';
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            if (!isGoogleMapsReady) {
                mostrarMensagemErro("❌ Os serviços de mapa ainda não estão prontos. Tente recarregar a página.");
                return;
            }

            document.getElementById("resultado").innerText = "Calculando...";
            
            let tipoVeiculo;
            let cilindrada = 0; 
            let coordOrigem, coordDestino;
            let origemAddress, destinoAddress;

            try {
                // 1. Obter e Validar Inputs
                tipoVeiculo = document.getElementById("tipo").value;
                if (!tipoVeiculo) throw new Error("Selecione o tipo de veículo.");

                origemAddress = document.getElementById("origem").value; 
                destinoAddress = document.getElementById("destino").value; 

                if (!origemAddress || origemAddress.includes("Selecione a Origem")) throw new Error("Defina o endereço de Origem primeiro.");
                if (!destinoAddress || destinoAddress.includes("Selecione o Destino")) throw new Error("Defina o endereço de Destino primeiro.");

                if (tipoVeiculo === "15") {
                    cilindrada = parseInt(document.getElementById("cilindrada-moto").value);
                    if (isNaN(cilindrada)) throw new Error("Informe a cilindrada da moto.");
                }
                
                // 2. Determinar Coordenadas de Origem (Apenas Autocomplete, Mapa ou Geo são válidos)
                const savedLonOrigem = parseFloat(document.getElementById("coord-origem-lon").value);
                const savedLatOrigem = parseFloat(document.getElementById("coord-origem-lat").value);
                const currentOriginMode = document.querySelector('input[name="origin-choice"]:checked').value;


                if (!isNaN(savedLonOrigem) && !isNaN(savedLatOrigem)) {
                    coordOrigem = new google.maps.LatLng(savedLatOrigem, savedLonOrigem);
                    
                    // Tratamento do Endereço para WhatsApp
                    origemAddress = origemAddress.replace(/\(CONFIRMADO\)/g, '').replace('(LOCALIZAÇÃO ATUAL)', '').replace('(AUTOCOMPLETADO)', '').trim();
                    
                    if (currentOriginMode === 'auto') {
                        const numeroAuto = document.getElementById("numero-origem-auto").value;
                        if (!numeroAuto) throw new Error("Informe o número do endereço de Origem (por texto).");
                        origemAddress = `${origemAddress}, Nº ${numeroAuto}`;
                    }

                } else {
                    throw new Error("As coordenadas de Origem não foram definidas. Use um dos métodos acima.");
                }

                // 3. Determinar Coordenadas de Destino (Apenas Autocomplete ou Mapa são válidos)
                const savedDestLon = parseFloat(document.getElementById("coord-destino-lon").value);
                const savedDestLat = parseFloat(document.getElementById("coord-destino-lat").value);
                const currentDestinationMode = document.querySelector('input[name="destination-choice"]:checked').value;
                
                if (!isNaN(savedDestLon) && !isNaN(savedDestLat)) {
                    coordDestino = new google.maps.LatLng(savedDestLat, savedDestLon);
                    
                    // Tratamento do Endereço para WhatsApp
                    destinoAddress = destinoAddress.replace(/\(CONFIRMADO\)/g, '').replace('(AUTOCOMPLETADO)', '').trim();
                    
                    if (currentDestinationMode === 'auto') {
                        const numeroAuto = document.getElementById("numero-destino-auto").value;
                        if (!numeroAuto) throw new Error("Informe o número do endereço de Destino (por texto).");
                        destinoAddress = `${destinoAddress}, Nº ${numeroAuto}`;
                    }

                } else {
                     throw new Error("As coordenadas de Destino não foram definidas. Use um dos métodos acima.");
                }
                
                // 4. Determinar Taxa Fixa
                let taxa = 0;
                if (tipoVeiculo === "50") taxa = 50;
                else if (tipoVeiculo === "15") {
                    if (cilindrada <= 160) taxa = 15;
                    else if (cilindrada <= 250) taxa = 25;
                    else if (cilindrada <= 499) taxa = 35;
                    else if (cilindrada <= 999) taxa = 50;
                    else taxa = 100;
                }

                // 5. Calcular Rotas (DirectionsService)
                const coordBase = new google.maps.LatLng(BASE_ADDRESS.lat, BASE_ADDRESS.lng);
                
                const [dist1, dist2, dist3] = await Promise.all([
                    getDistance(coordBase, coordOrigem),    // Base -> Origem
                    getDistance(coordOrigem, coordDestino), // Origem -> Destino
                    getDistance(coordDestino, coordBase)    // Destino -> Base
                ]); 

                // 6. Apresentar Resultado
                const distanciaTotalKm = dist1 + dist2 + dist3;
                const valorKm = distanciaTotalKm * 1.7; // R$ 1,70 por km
                const valorTotal = valorKm + taxa;
                
                const detalhesMoto = tipoVeiculo === "15" ? 
                    ` (Cilindrada: ${document.getElementById("cilindrada-moto").value}cc)` : '';
                
                document.getElementById("resultado").innerText =
                    `Detalhes da Rota:\n` +
                    `Base → Origem: ${dist1.toFixed(2)} km\n` +
                    `Origem → Destino: ${dist2.toFixed(2)} km\n` +
                    `Destino → Base: ${dist3.toFixed(2)} km\n\n` +
                    `Distância Total (ida e volta): ${distanciaTotalKm.toFixed(2)} km\n` +
                    `Custo por KM (R$ 1,70/km): R$ ${valorKm.toFixed(2)}\n` +
                    `Taxa Fixa (Veículo: ${tipoVeiculo === '50' ? 'Carro' : 'Moto'}${detalhesMoto}): R$ ${taxa.toFixed(2)}\n` +
                    `\n💰 VALOR TOTAL ESTIMADO: R$ ${valorTotal.toFixed(2)}`;
                
                // Exibe os botões de ação
                updateWhatsappButton(origemAddress, destinoAddress, valorTotal);
                document.getElementById("nova-consulta-container").style.display = 'block';
                
            } catch (error) {
                console.error("Erro no cálculo:", error);
                
                let userMessage = error.message;

                if (userMessage.includes("Rota não encontrada")) {
                    userMessage = `Não foi possível traçar a rota. Verifique a precisão dos endereços.`;
                } else if (userMessage.includes("Informe o número")) {
                     // Mantém a mensagem de erro específica
                } else {
                    userMessage = `Falha geral no cálculo: ${userMessage}`;
                }

                mostrarMensagemErro(`❌ Erro: ${userMessage}`); 
                document.getElementById("resultado").innerText = "❌ Erro no cálculo. Verifique a mensagem acima.";
                
                // Garante que os botões de ação fiquem ocultos em caso de erro
                document.getElementById("whatsapp-container").style.display = 'none';
                document.getElementById("nova-consulta-container").style.display = 'none';
            }
        }
        
        // --- FUNÇÃO DE CONFIRMAÇÃO DO MAPA ---
        function confirmMapSelection() {
            if (!currentMapMode) return; 

            limparMensagemErro();
            let coordLatField, addressField, inputPrefix;

            if (currentMapMode === 'ORIGIN') {
                coordLatField = document.getElementById('coord-origem-lat');
                addressField = document.getElementById('origem');
                inputPrefix = 'Origem';
            } else { // DESTINATION
                coordLatField = document.getElementById('coord-destino-lat');
                addressField = document.getElementById('destino');
                inputPrefix = 'Destino';
            }

            // Checa se o ponto foi clicado no mapa (se as coordenadas temporárias estão preenchidas)
            if (coordLatField.value === "") {
                mostrarMensagemErro(`❌ Por favor, CLIQUE no mapa para definir o ponto de ${inputPrefix} antes de confirmar.`);
                return;
            }

            // 1. Ocultar seção do mapa
            document.getElementById("map-interaction-section").style.display = 'none';

            // 2. Resetar o modo
            currentMapMode = null;
            
            // 3. Ocultar marcadores 
            if (originMarker) originMarker.setVisible(false);
            if (destinationMarker) destinationMarker.setVisible(false);

            // 4. Feedback visual e atualização do campo 
            addressField.value = addressField.value.replace(/\(Mapa\)/g, '').trim() + " (CONFIRMADO)";
            addressField.style.fontWeight = 'bold';
        }
        
        // === LÓGICA DE TOGGLE PARA ORIGEM (3 OPÇÕES) ===
        
        function toggleOriginInput(choice) {
            limparMensagemErro();
            const geoBlock = document.getElementById("origin-geo-block");
            const autoBlock = document.getElementById("origin-autocomplete-block"); 
            const origemField = document.getElementById("origem");
            const mapSection = document.getElementById("map-interaction-section");
            
            // 1. Limpa o estado e esconde tudo
            mapSection.style.display = 'none';
            geoBlock.style.display = 'none';
            autoBlock.style.display = 'none'; 

            // Expressão que define se o campo principal (origem) tem coordenadas (geo, mapa, auto)
            const isCoordSet = origemField.value.includes("(CONFIRMADO)") || 
                               origemField.value.includes("(LOCALIZAÇÃO ATUAL)") || 
                               origemField.value.includes("(AUTOCOMPLETADO)");

            // 2. Limpa Coordenadas Salvas e Endereço de Exibição
            // Se estiver mudando de um modo baseado em coordenadas (map/geo/auto) para outro, limpa as coordenadas para forçar a nova definição.
            if (isCoordSet) {
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
                origemField.style.fontWeight = 'normal';
                origemField.value = "";
            }
            
            // Ocultar marcadores 
            if (originMarker) originMarker.setVisible(false);
            if (destinationMarker) destinationMarker.setVisible(false);
            currentMapMode = null;
            
            // 3. Ativa o bloco e ajusta o placeholder
            if (choice === 'geo') {
                geoBlock.style.display = 'block';
                origemField.placeholder = "Endereço gerado após obter Localização Atual";

            } else if (choice === 'map') {
                // Ativa o modo Mapa
                currentMapMode = 'ORIGIN';
                document.getElementById("origin-map-placeholder").appendChild(mapSection);
                mapSection.style.display = 'block';
                
                if (map && originMarker) {
                    google.maps.event.trigger(map, 'resize'); 
                    const center = originMarker.getPosition() || new google.maps.LatLng(RIO_CENTER.lat, RIO_CENTER.lng);
                    map.setCenter(center);
                    map.setZoom(14); 
                }
                
                document.getElementById("map-status").textContent = `Modo Ativo: CLIQUE no mapa para definir o ponto de ORIGEM.`;
                if (originMarker) originMarker.setVisible(true);
                
                mapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                origemField.placeholder = "Endereço definido pelo mapa (Aguardando Confirmação)";

            } else if (choice === 'auto') { // NOVO MODO AUTOCOMPLETE
                autoBlock.style.display = 'block';
                origemField.placeholder = "Endereço gerado após selecionar a sugestão";
            }
        }
        
        // === LÓGICA DE TOGGLE PARA DESTINO (2 OPÇÕES) ===

        function toggleDestinationInput(choice) {
            limparMensagemErro();
            const autoBlock = document.getElementById("destination-autocomplete-block"); 
            const destinoField = document.getElementById("destino");
            const mapSection = document.getElementById("map-interaction-section");
            
            // 1. Limpa o estado e esconde tudo
            mapSection.style.display = 'none';
            autoBlock.style.display = 'none'; 
            
            // Expressão que define se o campo principal (destino) tem coordenadas (mapa, auto)
            const isCoordSet = destinoField.value.includes("(CONFIRMADO)") || 
                               destinoField.value.includes("(AUTOCOMPLETADO)");

            // 2. Limpa Coordenadas Salvas e Endereço de Exibição
            if (isCoordSet) {
                document.getElementById("coord-destino-lon").value = "";
                document.getElementById("coord-destino-lat").value = "";
                destinoField.style.fontWeight = 'normal';
                destinoField.value = "";
            }
            
            // Ocultar marcadores
            if (originMarker) originMarker.setVisible(false);
            if (destinationMarker) destinationMarker.setVisible(false);
            currentMapMode = null;

            
            // 3. Ativa o bloco e ajusta o placeholder
            if (choice === 'map') {
                // Ativa o modo Mapa
                currentMapMode = 'DESTINATION';
                
                document.getElementById("destination-map-placeholder").appendChild(mapSection);
                mapSection.style.display = 'block';

                if (map && destinationMarker) {
                    google.maps.event.trigger(map, 'resize'); 
                    
                    const center = destinationMarker.getPosition() || RIO_CENTER;
                    map.setCenter(center);
                    map.setZoom(14); 
                }
                
                document.getElementById("map-status").textContent = `Modo Ativo: CLIQUE no mapa para definir o ponto de DESTINO.`;
                if (destinationMarker) destinationMarker.setVisible(true);
                
                mapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                destinoField.placeholder = "Endereço definido pelo mapa (Aguardando Confirmação)";

            } else if (choice === 'auto') { // NOVO MODO AUTOCOMPLETE
                autoBlock.style.display = 'block';
                destinoField.placeholder = "Endereço gerado após selecionar a sugestão";
            }
        }

        async function handleMapClick(event) {
            if (!currentMapMode) return;
            
            limparMensagemErro();
            let marker, addressField, coordLatField, coordLonField, inputPrefix;
            
            const mapStatus = document.getElementById("map-status");
            mapStatus.textContent = "Buscando endereço (Geocoding Reverso)...";

            try {
                const enderecoTexto = await reverseGeocode(event.latLng);
                
                if (currentMapMode === 'ORIGIN') {
                    marker = originMarker;
                    addressField = document.getElementById('origem');
                    coordLatField = document.getElementById('coord-origem-lat');
                    coordLonField = document.getElementById('coord-origem-lon');
                    inputPrefix = 'Origem';
                    // Limpar inputs de Autocomplete ao usar mapa
                    document.getElementById("numero-origem-auto").value = "";
                    document.getElementById("input-endereco-origem").value = "";
                    
                } else { // 'DESTINATION'
                    marker = destinationMarker;
                    addressField = document.getElementById('destino');
                    coordLatField = document.getElementById('coord-destino-lat');
                    coordLonField = document.getElementById('coord-destino-lon');
                    inputPrefix = 'Destino';
                    // Limpar inputs de Autocomplete ao usar mapa
                    document.getElementById("numero-destino-auto").value = "";
                    document.getElementById("input-endereco-destino").value = "";
                }

                // 1. Atualiza o Marcador
                marker.setPosition(event.latLng);
                marker.setVisible(true);
                
                // 2. Atualiza o Endereço de Texto (Adiciona (Mapa) para sinalizar que precisa confirmar)
                addressField.value = `${enderecoTexto} (Mapa)`;
                addressField.style.fontWeight = 'normal'; // Tira o negrito enquanto não confirma
                
                // 3. Atualiza as Coordenadas Ocultas (Para o cálculo)
                coordLatField.value = event.latLng.lat();
                coordLonField.value = event.latLng.lng();
                
                mapStatus.textContent = `${inputPrefix} temporariamente definido. Clique em 'Confirmar Localização'.`;

            } catch (e) {
                mostrarMensagemErro(`❌ Erro ao definir localização: ${e.message}`);
            }
        }
        
        // --- FLUXO DE BUSCA DE ENDEREÇO COM GEOLOCALIZAÇÃO ---
        
        async function usarLocalizacaoAtual() {
            if (!isGoogleMapsReady) {
                 mostrarMensagemErro("❌ Os serviços de mapa ainda não estão prontos.");
                 return;
            }
            limparMensagemErro();
            document.getElementById("origem").value = "Buscando localização...";
            document.getElementById("btn-usar-localizacao").disabled = true;
            document.getElementById("origem").style.fontWeight = 'normal';


            if (!navigator.geolocation) {
                mostrarMensagemErro("❌ Seu navegador não suporta geolocalização.");
                document.getElementById("origem").value = "";
                document.getElementById("btn-usar-localizacao").disabled = false;
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                const latlng = { lat: lat, lng: lon };
                
                // 1. Tentar reverter as coordenadas para endereço de texto (Google Maps)
                const enderecoTexto = await reverseGeocode(latlng);
                
                // 2. Salvar as coordenadas reais nos campos hidden para usar no cálculo
                document.getElementById("coord-origem-lon").value = lon;
                document.getElementById("coord-origem-lat").value = lat;

                // 3. Limpar outros inputs e popular campo de endereço
                document.getElementById("origem").value = `(LOCALIZAÇÃO ATUAL) ${enderecoTexto}`;
                document.getElementById("origem").style.fontWeight = 'bold';
                
                document.getElementById("numero-origem-auto").value = "";
                document.getElementById("input-endereco-origem").value = "";


            } catch (error) {
                let msg = "Erro ao obter localização. Verifique as permissões do navegador.";
                if (error.code === 1) {
                    msg = "Permissão de geolocalização negada pelo usuário.";
                } else if (error.code === 3) {
                    msg = "Tempo limite excedido para obter localização.";
                } else {
                    msg = `Falha na geolocalização: ${error.message}`;
                }
                mostrarMensagemErro(`❌ ${msg}`);
                document.getElementById("origem").value = "";
                document.getElementById("coord-origem-lon").value = "";
                document.getElementById("coord-origem-lat").value = "";
            } finally {
                document.getElementById("btn-usar-localizacao").disabled = false;
            }
        }

        // --- SETUP INICIAL ---
        window.onload = function() {
            
            document.getElementById("btn-calcular").addEventListener("click", calcular);
            document.getElementById("btn-nova-consulta").addEventListener("click", resetForm); 
            
            // Listeners removidos: btn-buscar-origem-cep e btn-buscar-destino-cep
            document.getElementById("btn-usar-localizacao").addEventListener("click", usarLocalizacaoAtual);
            document.getElementById("btn-confirmar-mapa").addEventListener("click", confirmMapSelection);
            
            // Listener para o Radio Group (Alternância de Origem)
            document.querySelectorAll('input[name="origin-choice"]').forEach(radio => {
                radio.addEventListener('change', (e) => toggleOriginInput(e.target.value));
            });
            
            // Listener para o Radio Group (Alternância de Destino)
            document.querySelectorAll('input[name="destination-choice"]').forEach(radio => {
                radio.addEventListener('change', (e) => toggleDestinationInput(e.target.value));
            });
            
            document.getElementById("tipo").addEventListener("change", e => {
                const showMoto = e.target.value === "15";
                document.getElementById("detalhes-moto").style.display = showMoto ? "block" : "none";
                
                if (!showMoto) {
                    document.getElementById("marca-moto").value = "";
                    document.getElementById("modelo-moto").value = "";
                    document.getElementById("cilindrada-moto").value = "";
                }
            });
            
            // Inicializa o estado dos botões de ação como ocultos
            document.getElementById("whatsapp-container").style.display = 'none';
            document.getElementById("nova-consulta-container").style.display = 'none';
            document.getElementById("whatsapp-solicitar-btn").setAttribute('disabled', 'true');
            
            // Injeção do script do Google Maps com a biblioteca 'places' e 'geometry'
            if (API_KEY_GOOGLE) {
                 const script = document.createElement('script');
                 // A função initMap é definida no JS e será chamada quando o script carregar
                 script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY_GOOGLE}&libraries=geometry,places&callback=initMap`;
                 script.onerror = () => {
                     mostrarMensagemErro("❌ Falha no carregamento dos serviços de mapa. Tente recarregar a página."); 
                 };
                 document.head.appendChild(script);
            } else {
                 mostrarMensagemErro("❌ Chave de API de mapa não configurada. O cálculo não funcionará.");
            }
        };
    </script>
</head>
<body>
    <main class="container">
        <h1 class="logo-placeholder">🚚 Gbservice Reboque</h1>
        
        <div id="mensagem-erro" class="mensagem-erro" style="display: none;"></div>
        
        <!-- CAMPOS HIDDEN PARA SALVAR COORDENADAS -->
        <input type="hidden" id="coord-origem-lon" value="" />
        <input type="hidden" id="coord-origem-lat" value="" />
        <input type="hidden" id="coord-destino-lon" value="" />
        <input type="hidden" id="coord-destino-lat" value="" />

        <section class="section endereco-section">
            <h2>Local do Veículo (Origem)</h2>
            
            <div class="input-toggle">
                <label>Como deseja informar a Origem?</label>
                <div class="radio-group">
                    <input type="radio" id="choice-origem-auto" name="origin-choice" value="auto" checked>
                    <label for="choice-origem-auto">Endereço por Texto</label>
                    
                    <input type="radio" id="choice-origem-geo" name="origin-choice" value="geo">
                    <label for="choice-origem-geo">Localização Atual</label>
                    
                    <input type="radio" id="choice-origem-map" name="origin-choice" value="map">
                    <label for="choice-origem-map">Selecionar no Mapa</label>
                </div>
            </div>
            
            <!-- BLOCO DE AUTOCOMPLETE (Origem) com Número Adicionado -->
            <div id="origin-autocomplete-block" class="input-block">
                <div class="form-group">
                    <label for="input-endereco-origem">Digite a Rua/Avenida (Será autocompletado):</label>
                    <input type="text" id="input-endereco-origem" placeholder="Ex: Av. Brasil" />
                    <small style="color: #666; margin-top: 5px;">Selecione uma sugestão da lista.</small>
                </div>
                <div class="form-group">
                    <label for="numero-origem-auto">Número:</label>
                    <input type="number" id="numero-origem-auto" placeholder="Número do endereço (Obrigatório)" required />
                </div>
            </div>

            <!-- BLOCO DE INPUT POR GEOLOCALIZAÇÃO -->
            <div id="origin-geo-block" class="input-block" style="display: none;">
                <button id="btn-usar-localizacao" type="button" style="background-color: #38a169; margin-bottom: 10px;">
                    Usar Minha Localização Atual
                </button>
            </div>
            
            <!-- Placeholder para o mapa de Origem -->
            <div id="origin-map-placeholder"></div>
            
            <!-- CAMPO DE ENDEREÇO RESULTANTE (comum aos métodos) -->
            <div class="form-group">
                <label for="origem">Endereço de Origem (Gerado automaticamente):</label>
                <input disabled type="text" id="origem" placeholder="Selecione a Origem" autocomplete="street-address" />
            </div>
        </section>

        <section class="section destino-section">
            <h2>Destino do Reboque</h2>
            
            <div class="input-toggle">
                <label>Como deseja informar o Destino?</label>
                <div class="radio-group">
                    <input type="radio" id="choice-dest-auto" name="destination-choice" value="auto" checked>
                    <label for="choice-dest-auto">Endereço por Texto</label>
                    
                    <input type="radio" id="choice-dest-map" name="destination-choice" value="map">
                    <label for="choice-dest-map">Selecionar no Mapa</label>
                </div>
            </div>
            
            <!-- BLOCO DE AUTOCOMPLETE (Destino) com Número Adicionado -->
            <div id="destination-autocomplete-block" class="input-block">
                <div class="form-group">
                    <label for="input-endereco-destino">Digite a Rua/Avenida (Será autocompletado):</label>
                    <input type="text" id="input-endereco-destino" placeholder="Ex: Av. Rio Branco" />
                    <small style="color: #666; margin-top: 5px;">Selecione uma sugestão da lista.</small>
                </div>
                <div class="form-group">
                    <label for="numero-destino-auto">Número:</label>
                    <input type="number" id="numero-destino-auto" placeholder="Número do endereço (Obrigatório)" required />
                </div>
            </div>

            <!-- Placeholder para o mapa de Destino -->
            <div id="destination-map-placeholder"></div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label for="destino">Endereço de destino (Gerado automaticamente):</label>
                <input disabled type="text" id="destino" placeholder="Selecione o Destino" autocomplete="address-line1" />
            </div>
            
            <div class="form-group">
                <label for="tipo">Tipo de Veículo:</label>
                <select id="tipo" aria-label="Tipo de veículo">
                    <option value="" disabled selected>Selecione</option>
                    <option value="50">Carro</option>
                    <option value="15">Moto</option>
                </select>
            </div>
            <div id="detalhes-moto" style="display: none;">
                <div class="form-group">
                    <label for="marca-moto">Marca:</label>
                    <input type="text" id="marca-moto" placeholder="Ex.: Honda" />
                </div>
                <div class="form-group">
                    <label for="modelo-moto">Modelo:</label>
                    <input type="text" id="modelo-moto" placeholder="Ex.: CG Titan" />
                </div>
                <div class="form-group">
                    <label for="cilindrada-moto">Cilindrada:</label>
                    <input type="number" id="cilindrada-moto" placeholder="Ex.: 160" />
                </div>
            </div>
        </section>
        
        <!-- SEÇÃO DE INTERAÇÃO COM O MAPA (Esta seção é movida dinamicamente para o placeholder ativo) -->
        <section id="map-interaction-section" class="section" style="display: none;">
            <div id="map-canvas"></div> <!-- O mapa aparece primeiro -->
            <div class="map-controls">
                 <p id="map-status" class="map-status">Clique no mapa para definir o ponto.</p>
                 <button id="btn-confirmar-mapa" type="button">Confirmar Localização</button>
            </div>
        </section>
        <!-- FIM SEÇÃO DE INTERAÇÃO COM O MAPA -->

        <section class="section acao-section">
            <button id="btn-calcular" type="button">Calcular valor</button>
        </section>

        <section class="section resultado-section" aria-live="polite" aria-atomic="true">
            <div id="resultado">Preencha todos os campos e clique em CALCULAR.</div>
        </section>

        <section class="section whatsapp-section">
            <div id="whatsapp-container" style="display: none;">
                <button id="whatsapp-solicitar-btn" class="whatsapp-button" disabled>Solicitar reboque via WhatsApp</button>
            </div>
            <!-- BOTÃO DE NOVA CONSULTA -->
            <div id="nova-consulta-container" style="display: none; margin-top: 15px;">
                <button id="btn-nova-consulta" type="button" style="background-color: #f59e0b;">Nova Consulta</button>
            </div>
        </section>
        <footer class="footer">
            <p>Desenvolvido por <strong>Natanael Costa</strong></p>
        </footer>
    </main>
</body>
</html>
